<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haber Bildirim Testi v2</title>
</head>
<body style="font-family: sans-serif; text-align: center; padding: 20px;">

    <h2>ðŸ”” Bildirim Test SayfasÄ± (DÃ¼zeltildi)</h2>
    <p>AÅŸaÄŸÄ±daki butona basarak bildirim izni verin.</p>
    
    <button id="btn-notify" style="padding: 15px 30px; font-size: 16px; cursor: pointer; background-color: #28a745; color: white; border: none; border-radius: 5px;">
        Bildirimleri AÃ§
    </button>
    
    <div style="margin-top: 20px;">
        <h3>Durum:</h3>
        <p id="status-text" style="color: blue;">HazÄ±r.</p>

        <h3>OluÅŸan Token:</h3>
        <textarea id="token-display" rows="5" style="width: 100%; max-width: 500px; padding: 10px;"></textarea>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging.js";

        // Config Bilgilerin
        const firebaseConfig = {
            apiKey: "AIzaSyAr5FUC9uAmPkRWz1nqtllBodHYqpBB9ac",
            authDomain: "arabicinlevels.firebaseapp.com",
            projectId: "arabicinlevels",
            storageBucket: "arabicinlevels.firebasestorage.app",
            messagingSenderId: "240587696722",
            appId: "1:240587696722:web:6ad23e4fb519a1e5db8d8b",
            measurementId: "G-10RV9BVZWS"
        };

        const app = initializeApp(firebaseConfig);
        const messaging = getMessaging(app);
        
        const vapidKey = "BEWRdNwkPd2Gmi29zUGl5BJJ8Glnjs-jYlBjbogwYHKfcifVBOnVTQyJJNfFwObMFmNFG21W2tb0afSzI6NQwP0";

        const statusText = document.getElementById('status-text');

        document.getElementById('btn-notify').addEventListener('click', async () => {
            statusText.innerText = "Ä°zin isteniyor...";
            
            try {
                const permission = await Notification.requestPermission();
                
                if (permission === 'granted') {
                    statusText.innerText = "Ä°zin verildi. Service Worker kuruluyor...";
                    
                    // DÃœZELTME BURADA YAPILDI:
                    // Ã–nce Service Worker'Ä± kaydet ve kaydÄ± (registration) bir deÄŸiÅŸkene al.
                    if ('serviceWorker' in navigator) {
                        const registration = await navigator.serviceWorker.register('./firebase-messaging-sw.js');
                        console.log("SW Kaydedildi:", registration);

                        statusText.innerText = "Token alÄ±nÄ±yor...";

                        // Token isterken "hazÄ±r" olan registration nesnesini elle veriyoruz.
                        const currentToken = await getToken(messaging, { 
                            vapidKey: vapidKey,
                            serviceWorkerRegistration: registration 
                        });

                        if (currentToken) {
                            console.log('Token:', currentToken);
                            document.getElementById('token-display').value = currentToken;
                            statusText.innerText = "BaÅŸarÄ±lÄ±! Token kutuda.";
                            alert("Token baÅŸarÄ±yla alÄ±ndÄ±!");
                        } else {
                            statusText.innerText = "Token oluÅŸturulamadÄ±.";
                        }
                    } else {
                        alert("TarayÄ±cÄ±nÄ±z Service Worker desteklemiyor.");
                    }

                } else {
                    statusText.innerText = "Ä°zin reddedildi.";
                    alert('Bildirim izni vermediniz.');
                }
            } catch (err) {
                console.error('Hata:', err);
                statusText.innerText = "Hata oluÅŸtu: " + err.message;
                alert("Hata: " + err.message); // Mobilde hatayÄ± gÃ¶rmek iÃ§in
            }
        });

        onMessage(messaging, (payload) => {
            console.log('Ã–n planda mesaj:', payload);
            alert(`YENÄ° HABER: ${payload.notification.title}\n${payload.notification.body}`);
        });
    </script>
</body>
</html>