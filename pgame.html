<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Türkiye Şehir Avcısı | PGame Pro</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Cinzel:wght@700&family=Great+Vibes&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />

    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e74c3c;
            --success: #27ae60;
            --bg-water: #aadaff;
        }

        body { margin: 0; padding: 0; font-family: 'Montserrat', sans-serif; overflow: hidden; background: var(--bg-water); }
        
        /* --- HARİTA --- */
        #map { width: 100%; height: 100vh; background: var(--bg-water); z-index: 1; }

        /* --- UI KATMANLARI --- */
        .game-ui {
            position: absolute; z-index: 1000; pointer-events: none;
            width: 100%; height: 100%; top: 0; left: 0;
            display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Üst Panel */
        .top-panel {
            margin-top: 20px; align-self: center;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
            pointer-events: auto; width: 90%; max-width: 450px;
        }

        .score-board {
            background: rgba(255, 255, 255, 0.95);
            padding: 8px 20px; border-radius: 50px;
            font-weight: 800; color: var(--primary);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            font-size: 1rem; display: flex; align-items: center; gap: 15px;
        }

        .question-box {
            background: var(--accent); color: white;
            padding: 15px 0; border-radius: 12px;
            text-align: center; box-shadow: 0 10px 25px rgba(231, 76, 60, 0.4);
            width: 100%; transition: transform 0.2s;
        }
        
        .find-text { font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px;}
        .city-name { font-size: 2rem; font-weight: 800; line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }

        /* Alt Alanlar */
        .bottom-area {
            display: flex; justify-content: space-between; align-items: flex-end;
            padding: 20px; pointer-events: auto;
        }

        /* Sol Alt Bilgi */
        .info-box {
            background: rgba(255,255,255,0.95); padding: 15px; border-radius: 10px;
            width: 260px; font-size: 0.85rem; color: #444; line-height: 1.4;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .info-toggle { display: none; width: 40px; height: 40px; background: white; border-radius: 50%; text-align: center; line-height: 40px; font-weight: bold; font-size: 1.2rem; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.2); color: var(--primary); }

        /* Sağ Alt Footer (Sayaç & Credits) */
        .footer-right {
            text-align: right;
            display: flex; flex-direction: column; align-items: flex-end; gap: 5px;
        }

        .counter-wrapper {
            background: rgba(255,255,255,0.8);
            padding: 2px 8px; border-radius: 4px;
            font-size: 0; /* İçindeki iframe boşluklarını silmek için */
            display: inline-block;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transform: scale(0.8); transform-origin: right bottom;
            cursor: pointer;
        }

        .credits {
            font-size: 0.7rem; color: var(--primary); background: rgba(255,255,255,0.6);
            padding: 4px 8px; border-radius: 4px; font-weight: 600;
        }
        .credits a { color: var(--accent); text-decoration: none; }

        /* Mesajlar */
        #feedback-msg {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 4rem; font-weight: 900; text-shadow: 0 5px 20px rgba(0,0,0,0.3);
            opacity: 0; pointer-events: none; z-index: 2000;
        }

        /* --- SERTİFİKA MODAL --- */
        #modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(44, 62, 80, 0.9); z-index: 3000;
            justify-content: center; align-items: center; flex-direction: column;
            backdrop-filter: blur(8px);
        }
        
        .modal-card {
            background: #fff; padding: 40px; width: 90%; max-width: 500px;
            text-align: center; border-radius: 15px; position: relative;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .modal-input {
            width: 80%; padding: 12px; margin: 20px 0;
            border: 2px solid #ddd; border-radius: 6px; font-size: 1rem;
            font-family: 'Montserrat', sans-serif; text-align: center;
        }

        .btn {
            background: var(--primary); color: white; border: none;
            padding: 12px 30px; border-radius: 6px; font-size: 1rem;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }
        .btn:hover { background: #34495e; transform: translateY(-2px); }
        .btn-download { background: var(--success); margin-top: 10px; }

        /* Gizli Canvas Alanı (Sertifika Çizimi İçin) */
        #cert-canvas { display: none; }

        /* Mobil Ayarları */
        @media (max-width: 768px) {
            .info-box { display: none; }
            .info-toggle { display: block; }
            .city-name { font-size: 1.5rem; }
            .question-box { padding: 10px 0; }
            .bottom-area { padding: 10px; }
            .credits { font-size: 0.6rem; }
        }
    </style>
</head>
<body>

    <div id="map"></div>

    <div class="game-ui">
        <div class="top-panel">
            <div class="score-board">
                <span>Seri: <span id="streak-txt" style="color:var(--success)">0</span>/10</span>
            </div>
            <div class="question-box">
                <div class="find-text">Haritada Bul:</div>
                <div class="city-name" id="target-name">Yükleniyor...</div>
            </div>
        </div>

        <div id="feedback-msg"></div>

        <div class="bottom-area">
            <div class="left-wrapper">
                <div class="info-toggle" onclick="toggleInfo()">i</div>
                <div class="info-box" id="game-info">
                    <strong>Nasıl Oynanır?</strong><br>
                    Üstte yazan şehri haritada bul ve tıkla.<br>
                    10 seri doğru cevapta ismine özel sertifikayı kazan!<br>
                    <em style="font-size:0.75rem; color:#888;">Zoom yapmak için çift tıkla veya tekerleği kullan.</em>
                </div>
            </div>

            <div class="footer-right">
                <div class="counter-wrapper" title="Ziyaretçi İstatistikleri">
                   <script language="JavaScript" type="text/javascript" src="https://gnrcounter.com/counter.php?accId=17583012f9e4e7c1713eb7aba95897be"></script>
                    <noscript>
                    <a href="https://gnrcounter.com" title="Web Analytics">Web Analytics</a>
                    </noscript>
                    </div>
                
                <div class="credits">
                    designed by hmdysn & gemini | <a href="https://www.x.com/hmdysn" target="_blank">hmdysn</a>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-overlay">
        <div class="modal-card">
            <h2 style="color:var(--success); font-family:'Cinzel', serif; margin:0;">TEBRİKLER!</h2>
            <p style="color:#7f8c8d;">Türkiye Coğrafyası bilginizi kanıtladınız.</p>
            
            <div id="input-section">
                <p>Sertifika için isminizi giriniz:</p>
                <input type="text" id="player-name" class="modal-input" placeholder="Ad Soyad">
                <br>
                <button class="btn" onclick="generateCertificate()">Sertifikayı Hazırla</button>
            </div>

            <div id="download-section" style="display:none;">
                <p style="font-weight:bold; color:var(--primary);">Sertifikanız Hazır!</p>
                <button class="btn btn-download" onclick="downloadPDF()">PDF İndir</button>
                <button class="btn btn-download" style="background:#e67e22" onclick="downloadJPG()">JPEG İndir</button>
                <br><br>
                <button class="btn" style="background:#95a5a6; font-size:0.8rem;" onclick="location.reload()">Yeni Oyun</button>
            </div>
        </div>
    </div>

    <canvas id="cert-canvas" width="2000" height="1414"></canvas>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.4.0/dist/confetti.browser.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
        // --- AYARLAR ---
        const map = L.map('map', {
            center: [39.0, 35.5], // Türkiye Merkezi
            zoom: 6,
            minZoom: 5,
            maxZoom: 9,
            zoomControl: false,
            attributionControl: false
        });

        // Arka Plan (Sade, etiketsiz)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}{r}.png', {
            attribution: '©OpenStreetMap, ©CartoDB'
        }).addTo(map);

        let geojsonLayer;
        let targetCity = null;
        let streak = 0;
        let locked = false;

        // --- VERİ YÜKLEME ---
        // Türkiye İller GeoJSON (Güvenilir Kaynak)
        fetch('https://raw.githubusercontent.com/cihadturhan/tr-geojson/master/geo/tr-iller.json')
            .then(res => res.json())
            .then(data => {
                geojsonLayer = L.geoJson(data, {
                    style: style,
                    onEachFeature: onEachFeature
                }).addTo(map);
                
                nextQuestion();
            })
            .catch(err => {
                document.getElementById('target-name').innerText = "Harita Yüklenemedi!";
                console.error(err);
            });

        // --- STİL & OLAYLAR ---
        function style(feature) {
            return {
                fillColor: '#ecf0f1',
                weight: 1,
                opacity: 1,
                color: '#bdc3c7',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function highlightFeature(e) {
            if(locked) return;
            var layer = e.target;
            layer.setStyle({
                weight: 2,
                color: '#7f8c8d',
                dashArray: '',
                fillOpacity: 0.9,
                fillColor: '#f1c40f'
            });
            layer.bringToFront();
        }

        function resetHighlight(e) {
            if(locked) return;
            geojsonLayer.resetStyle(e.target);
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: highlightFeature,
                mouseout: resetHighlight,
                click: checkAnswer
            });
        }

        // --- OYUN MANTIĞI ---
        function nextQuestion() {
            if (!geojsonLayer) return;
            
            const layers = geojsonLayer.getLayers();
            const randomLayer = layers[Math.floor(Math.random() * layers.length)];
            
            targetCity = randomLayer.feature.properties; 
            // GeoJSON property kontrolü: Genelde 'name' veya 'il_adi' kullanılır.
            // Bu GeoJSON kaynağında 'name' kullanılıyor.
            
            document.getElementById('target-name').innerText = targetCity.name;
            locked = false;
        }

        function checkAnswer(e) {
            if(locked) return;
            
            const clickedProps = e.target.feature.properties;
            const feedback = document.getElementById('feedback-msg');

            if (clickedProps.name === targetCity.name) {
                // DOĞRU
                locked = true;
                streak++;
                document.getElementById('streak-txt').innerText = streak;

                e.target.setStyle({ fillColor: '#27ae60', color: '#1e8449', dashArray: '' });
                feedback.innerHTML = "<span style='color:#27ae60'>DOĞRU!</span>";
                feedback.style.opacity = 1;

                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });

                if (streak >= 10) {
                    setTimeout(winGame, 1000);
                } else {
                    setTimeout(() => {
                        geojsonLayer.resetStyle(e.target);
                        feedback.style.opacity = 0;
                        nextQuestion();
                    }, 1200);
                }

            } else {
                // YANLIŞ
                locked = true;
                e.target.setStyle({ fillColor: '#c0392b', color: '#922b21' });
                
                feedback.innerHTML = "<span style='color:#c0392b'>YANLIŞ!</span>";
                feedback.style.opacity = 1;
                streak = 0;
                document.getElementById('streak-txt').innerText = streak;

                // Doğrusunu Göster
                geojsonLayer.eachLayer(layer => {
                    if(layer.feature.properties.name === targetCity.name) {
                        layer.setStyle({ fillColor: '#f39c12', fillOpacity: 1 });
                    }
                });

                setTimeout(() => {
                    geojsonLayer.eachLayer(layer => geojsonLayer.resetStyle(layer)); // Hepsini resetle
                    feedback.style.opacity = 0;
                    nextQuestion();
                }, 2000);
            }
        }

        // --- SERTİFİKA OLUŞTURMA ---
        function winGame() {
            var end = Date.now() + (3 * 1000);
            (function frame() {
                confetti({ particleCount: 5, angle: 60, spread: 55, origin: { x: 0 } });
                confetti({ particleCount: 5, angle: 120, spread: 55, origin: { x: 1 } });
                if (Date.now() < end) { requestAnimationFrame(frame); }
            }());
            document.getElementById('modal-overlay').style.display = 'flex';
        }

        function generateCertificate() {
            const name = document.getElementById('player-name').value;
            if(!name) { alert("Lütfen isim giriniz."); return; }

            const canvas = document.getElementById('cert-canvas');
            const ctx = canvas.getContext('2d');
            
            // Arkaplan
            ctx.fillStyle = "#fff";
            ctx.fillRect(0,0, canvas.width, canvas.height);
            
            // Çerçeve
            ctx.lineWidth = 40;
            ctx.strokeStyle = "#2c3e50";
            ctx.strokeRect(40,40, canvas.width-80, canvas.height-80);
            
            ctx.lineWidth = 10;
            ctx.strokeStyle = "#e74c3c"; // Accent rengi
            ctx.strokeRect(90,90, canvas.width-180, canvas.height-180);

            // Yazılar
            ctx.textAlign = "center";
            
            // Başlık
            ctx.fillStyle = "#2c3e50";
            ctx.font = "bold 140px 'Cinzel'";
            ctx.fillText("BAŞARI SERTİFİKASI", canvas.width/2, 350);

            // İsim
            ctx.fillStyle = "#c0392b";
            ctx.font = "bold 120px 'Montserrat'";
            ctx.fillText(name.toUpperCase(), canvas.width/2, 600);
            
            // Çizgi
            ctx.beginPath();
            ctx.moveTo(canvas.width/2 - 400, 650);
            ctx.lineTo(canvas.width/2 + 400, 650);
            ctx.strokeStyle = "#bdc3c7";
            ctx.lineWidth = 5;
            ctx.stroke();

            // Açıklama Metni (İstenilen İfade)
            ctx.fillStyle = "#34495e";
            ctx.font = "italic 50px 'Montserrat'";
            const text1 = "Türkiye coğrafyasına dair bilginiz ve şehirlerin";
            const text2 = "coğrafi konumlarını başarıyla tespitiniz dolayısıyla";
            const text3 = "bu sertifikayı almaya hak kazandınız.";
            
            ctx.fillText(text1, canvas.width/2, 800);
            ctx.fillText(text2, canvas.width/2, 880);
            ctx.fillText(text3, canvas.width/2, 960);

            // Alt Bilgiler
            ctx.textAlign = "left";
            ctx.font = "40px 'Montserrat'";
            ctx.fillStyle = "#7f8c8d";
            const date = new Date().toLocaleDateString('tr-TR');
            const serial = "PG-" + Math.floor(Math.random() * 999999);
            
            ctx.fillText("Tarih: " + date, 200, 1200);
            ctx.fillText("Seri No: " + serial, 200, 1260);

            // İmza
            ctx.textAlign = "right";
            ctx.font = "80px 'Great Vibes'";
            ctx.fillStyle = "#2c3e50";
            ctx.fillText("PGame Pro.", canvas.width - 200, 1200);
            
            ctx.fillRect(canvas.width - 500, 1220, 320, 3); // İmza çizgisi

            // UI Değişimi
            document.getElementById('input-section').style.display = 'none';
            document.getElementById('download-section').style.display = 'block';
        }

        function downloadJPG() {
            const canvas = document.getElementById('cert-canvas');
            const link = document.createElement('a');
            link.download = 'PGame_Turkiye_Sertifika.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.9);
            link.click();
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const canvas = document.getElementById('cert-canvas');
            const imgData = canvas.toDataURL('image/jpeg', 0.9);
            
            // A4 Yatay (Landscape)
            const pdf = new jsPDF('l', 'mm', 'a4');
            const pdfWidth = pdf.internal.pageSize.getWidth();
            const pdfHeight = pdf.internal.pageSize.getHeight();
            
            pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, pdfHeight);
            pdf.save('PGame_Turkiye_Sertifika.pdf');
        }

        // --- UI YARDIMCILARI ---
        function toggleInfo() {
            const info = document.getElementById('game-info');
            info.style.display = (info.style.display === 'block') ? 'none' : 'block';
        }
    </script>
</body>
</html>
