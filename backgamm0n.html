<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pro Master Tavla - Final</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #121212;
            --wood-dark: #3e2723;
            --wood-light: #5d4037;
            --board-border: #2d1b16;
            --point-dark: #3e2723; /* Koyu ÃœÃ§gen */
            --point-light: #d7ccc8; /* AÃ§Ä±k ÃœÃ§gen */
            --accent: #ffb74d;
            --highlight: rgba(0, 255, 0, 0.4);
        }

        * { box-sizing: border-box; touch-action: manipulation; }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--bg-color);
            color: white;
            margin: 0;
            height: 100dvh; /* Mobilde adres Ã§ubuÄŸu sorunu iÃ§in */
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* --- LOBI (Overlay) --- */
        #lobby-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            display: flex; justify-content: center; align-items: center;
            z-index: 2000; backdrop-filter: blur(5px);
        }
        .lobby-box {
            background: #2c2c2c; padding: 30px; border-radius: 15px;
            text-align: center; width: 85%; max-width: 350px;
            border: 1px solid #555;
        }
        .lobby-box input {
            width: 100%; padding: 12px; margin: 15px 0;
            background: #111; border: 1px solid #444; color: white; border-radius: 5px;
        }
        .btn {
            width: 100%; padding: 12px; margin: 5px 0; border: none;
            border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 15px;
        }
        .btn-primary { background: var(--accent); color: black; }
        .btn-secondary { background: #444; color: white; }

        /* --- OYUN ALANI --- */
        #game-layout {
            display: none;
            flex-direction: column;
            width: 100%; height: 100%;
        }

        /* 1. Ãœst Bilgi */
        .top-bar {
            height: 50px; background: #222; display: flex;
            justify-content: space-between; align-items: center;
            padding: 0 15px; border-bottom: 1px solid #333;
        }
        .user-tag { display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .led { width: 10px; height: 10px; border-radius: 50%; background: #555; transition: 0.3s; }
        .led.on { background: #00e676; box-shadow: 0 0 8px #00e676; }
        #turn-msg { font-weight: bold; color: var(--accent); font-size: 14px; }

        /* 2. Tahta (Esnek Alan) */
        .board-container {
            flex: 1; /* Kalan tÃ¼m alanÄ± kapla */
            background: var(--board-border);
            padding: 10px; /* Mobilde Ã§erÃ§eve kalÄ±nlÄ±ÄŸÄ± */
            display: flex;
            position: relative;
        }
        .wood-surface {
            flex: 1;
            background: var(--wood-light);
            border: 2px solid rgba(0,0,0,0.5);
            display: flex;
            position: relative;
            box-shadow: inset 0 0 30px rgba(0,0,0,0.8);
        }

        /* Sol ve SaÄŸ Bloklar */
        .half-board {
            flex: 1; /* %50 geniÅŸlik */
            display: flex;
            position: relative;
            border-left: 1px solid rgba(0,0,0,0.2);
            border-right: 1px solid rgba(0,0,0,0.2);
        }
        
        /* Bar (Orta KÄ±sÄ±m) */
        .bar-area {
            width: 35px; /* Mobilde daraltÄ±ldÄ± */
            background: var(--wood-dark);
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            box-shadow: inset 0 0 10px #000;
            border-left: 2px solid #222;
            border-right: 2px solid #222;
        }

        /* ÃœÃ§gen SatÄ±rlarÄ± */
        .points-row {
            position: absolute; width: 100%; height: 45%; 
            display: flex;
        }
        .top-row { top: 0; }
        .bottom-row { bottom: 0; transform: rotate(180deg); }

        .point {
            flex: 1; /* AlanÄ± eÅŸit bÃ¶lÃ¼ÅŸ */
            height: 100%;
            position: relative;
            cursor: pointer;
        }
        /* ÃœÃ§gen Ã‡izimi */
        .point::before {
            content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            clip-path: polygon(50% 100%, 0 0, 100% 0);
            z-index: 1;
        }
        .point:nth-child(odd)::before { background: var(--point-dark); }
        .point:nth-child(even)::before { background: var(--point-light); }
        
        /* Highlight */
        .point.valid-move::before { background: var(--highlight) !important; }
        .point.selected::before { background: rgba(255, 215, 0, 0.5) !important; }

        /* --- PULLAR (Responsive) --- */
        .stack {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10;
            display: flex; flex-direction: column; align-items: center;
            padding-top: 5px;
        }
        /* Alttakiler (Rotate olduÄŸu iÃ§in) */
        .bottom-row .stack { 
            /* Rotate olduÄŸu iÃ§in "top" aslÄ±nda gÃ¶rsel olarak alt oluyor. 
               TaÅŸlarÄ± dizerken normal diziyoruz, gÃ¶rsel zaten dÃ¶nÃ¼yor. */
             padding-top: 5px; 
        }

        .checker {
            width: 85%; /* ÃœÃ§genin geniÅŸliÄŸinin %85'i */
            aspect-ratio: 1;
            border-radius: 50%;
            margin-bottom: -15%; /* Daha sÄ±kÄ± istif */
            box-shadow: 0 2px 4px rgba(0,0,0,0.6);
            position: relative;
        }
        .checker.white { background: radial-gradient(circle at 30% 30%, #fff, #ddd); border: 1px solid #bbb; }
        .checker.black { background: radial-gradient(circle at 30% 30%, #333, #000); border: 1px solid #000; }
        
        .checker-count {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: red; font-size: 10px; font-weight: bold;
        }

        /* Bar PullarÄ± */
        .bar-checker {
            width: 30px; height: 30px; border-radius: 50%; margin: 5px 0;
            box-shadow: 0 0 10px yellow; cursor: pointer;
        }

        /* 3. Kontrol Paneli (Alt) */
        .controls {
            height: 70px; background: #222;
            display: flex; justify-content: center; align-items: center; gap: 20px;
            border-top: 1px solid #333;
        }
        .ctrl-btn {
            padding: 12px 30px; border-radius: 30px; border: none;
            font-weight: bold; font-size: 16px; cursor: pointer;
        }
        .btn-roll { background: #00e676; color: #004d40; box-shadow: 0 4px 0 #00695c; }
        .btn-roll:active { transform: translateY(4px); box-shadow: none; }
        .btn-pass { background: #d32f2f; color: white; }

        /* Zarlar ve Mesaj (Ortada YÃ¼zen) */
        .overlay-center {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            pointer-events: none; z-index: 50;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .dice-box { display: flex; gap: 10px; }
        .die {
            width: 45px; height: 45px; background: #fff; border-radius: 8px;
            display: flex; justify-content: center; align-items: center;
            font-size: 22px; font-weight: bold; color: #000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid #ccc;
        }
        #game-msg {
            background: rgba(0,0,0,0.8); color: var(--accent);
            padding: 5px 15px; border-radius: 15px; font-size: 13px;
        }

        /* --- SOHBET --- */
        #chat-btn {
            position: fixed; bottom: 85px; right: 20px;
            width: 45px; height: 45px; border-radius: 50%;
            background: var(--accent); border: none; z-index: 100;
            box-shadow: 0 4px 8px rgba(0,0,0,0.5); font-size: 18px; cursor: pointer;
        }
        #chat-panel {
            position: fixed; bottom: 85px; right: 75px;
            width: 280px; height: 300px;
            background: #2c2c2c; border-radius: 10px;
            display: none; flex-direction: column;
            border: 1px solid #444; z-index: 99;
            box-shadow: 0 10px 50px rgba(0,0,0,0.8);
        }
        .chat-msgs { flex: 1; overflow-y: auto; padding: 10px; font-size: 12px; }
        .chat-inp { display: flex; padding: 5px; background: #222; border-radius: 0 0 10px 10px; }
        .chat-inp input { flex: 1; padding: 5px; border: none; border-radius: 3px; }
        .msg-row { margin-bottom: 4px; color: #ddd; }
        .msg-sys { color: #888; font-style: italic; }

        @media (max-width: 600px) {
            .board-container { padding: 5px; } /* Mobilde kenarÄ± incelt */
            .checker { margin-bottom: -25%; } /* Mobilde taÅŸlarÄ± daha Ã§ok sÄ±kÄ±ÅŸtÄ±r */
            #chat-panel { right: 10px; bottom: 140px; } /* Mobilde chat konumu */
        }
    </style>
</head>
<body>

    <div id="lobby-overlay">
        <div class="lobby-box">
            <h2 style="color: var(--accent); margin-top:0;">ðŸŽ² Pro Master Tavla</h2>
            <input type="text" id="roomName" value="masa1" placeholder="Oda Ä°smi">
            <button class="btn btn-primary" onclick="initGame('white')">BEYAZ (Oyunu Kur)</button>
            <button class="btn btn-secondary" onclick="initGame('black')">SÄ°YAH (KatÄ±l)</button>
        </div>
    </div>

    <div id="game-layout">
        <div class="top-bar">
            <div class="user-tag"><div id="led-white" class="led"></div> <span>Beyaz</span></div>
            <div id="turn-msg">BAÄžLANIYOR...</div>
            <div class="user-tag"><span>Siyah</span> <div id="led-black" class="led"></div></div>
        </div>

        <div class="board-container">
            <div class="wood-surface">
                
                <div class="half-board">
                    <div class="points-row top-row" id="tl"></div> <div class="points-row bottom-row" id="bl"></div> </div>

                <div class="bar-area">
                    <div id="bar-white" class="bar-checker white" style="display:none;" onclick="handleBar('white')"></div>
                    <div id="bar-black" class="bar-checker black" style="display:none;" onclick="handleBar('black')"></div>
                </div>

                <div class="half-board">
                    <div class="points-row top-row" id="tr"></div> <div class="points-row bottom-row" id="br"></div> </div>

                <div class="overlay-center">
                    <div id="game-msg"></div>
                    <div class="dice-box">
                        <div id="die1" class="die" style="display:none;"></div>
                        <div id="die2" class="die" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="rollBtn" class="ctrl-btn btn-roll" onclick="rollDice()" style="display:none;">ZAR AT</button>
            <button id="passBtn" class="ctrl-btn btn-pass" onclick="passTurn()" style="display:none;">PAS GEÃ‡</button>
        </div>
    </div>

    <button id="chat-btn" onclick="toggleChat()"><i class="fas fa-comment-alt"></i></button>
    <div id="chat-panel">
        <div class="chat-msgs" id="chat-box"></div>
        <div class="chat-inp">
            <input type="text" id="chatInput" placeholder="Mesaj..." onkeypress="if(event.key==='Enter') sendChat()">
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyARZya4A5Jf-Sb-DVEWWyuycYTBpbFugHE",
            authDomain: "backgamm0n.firebaseapp.com",
            databaseURL: "https://backgamm0n-default-rtdb.firebaseio.com",
            projectId: "backgamm0n",
            storageBucket: "backgamm0n.firebasestorage.app",
            messagingSenderId: "554189551640",
            appId: "1:554189551640:web:c500ada35668d650eeab6d"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let myColor = null, roomId = null, gameState = null, selectedIndex = -1;

        function initGame(color) {
            const r = document.getElementById('roomName').value;
            if(!r) return alert("Oda adÄ± girin!");
            roomId = r; myColor = color;
            document.getElementById('lobby-overlay').style.display = 'none';
            document.getElementById('game-layout').style.display = 'flex';
            
            // Auto-start check
            if(myColor === 'white') {
                db.ref(`games/${roomId}/board`).once('value', s => { if(!s.exists()) resetGame(); });
            }

            // Listeners
            setupPresence();
            db.ref(`games/${roomId}`).on('value', s => { 
                if(s.exists()) { gameState = s.val(); render(); updateUI(); }
            });
            listenChat();
        }

        function resetGame() {
            // Setup: Beyaz (Pos), Siyah (Neg)
            // 0 index -> Beyaz iÃ§in 24 (SaÄŸ Ãœst kÃ¶ÅŸe baÅŸlangÄ±Ã§ olsun mu? HayÄ±r standart tavla)
            // Bizim Mapping:
            // 0-5: SaÄŸ Alt (Beyaz Evi) -> Beyaz 23->0 topluyor.
            // 18-23: SaÄŸ Ãœst (Siyah Evi)
            const b = Array(24).fill(0);
            b[23]=2; b[12]=5; b[7]=3; b[5]=5; // Beyaz
            b[0]=-2; b[11]=-5; b[16]=-3; b[18]=-5; // Siyah
            
            db.ref(`games/${roomId}`).set({
                board: b, turn: 'white', dice: [], moves: [], bar: {white:0, black:0}, msg: "Oyun BaÅŸladÄ±"
            });
        }

        function setupPresence() {
            db.ref(".info/connected").on("value", s => {
                if(s.val()) db.ref(`games/${roomId}/p/${myColor}`).set(true).then(()=>db.ref(`games/${roomId}/p/${myColor}`).onDisconnect().set(false));
            });
            db.ref(`games/${roomId}/p`).on('value', s => {
                const v = s.val() || {};
                document.getElementById('led-white').className = `led ${v.white?'on':''}`;
                document.getElementById('led-black').className = `led ${v.black?'on':''}`;
            });
        }

        function render() {
            ['tl','bl','tr','br'].forEach(id => document.getElementById(id).innerHTML='');
            
            // Mapping: 0-5(br), 6-11(bl), 12-17(tl), 18-23(tr)
            for(let i=0; i<24; i++) {
                let tid;
                if(i<=5) tid='br'; else if(i<=11) tid='bl'; else if(i<=17) tid='tl'; else tid='tr';
                
                const box = document.getElementById(tid);
                const p = document.createElement('div');
                p.className = `point ${i===selectedIndex?'selected':''} ${checkValid(i)?'valid-move':''}`;
                p.onclick = () => handleClick(i);

                if(gameState.board[i] !== 0) {
                    const stack = document.createElement('div'); stack.className='stack';
                    const c = gameState.board[i];
                    const num = Math.abs(c);
                    const type = c>0?'white':'black';
                    const max = num>5?5:num;
                    for(let k=0; k<max; k++) {
                        const ch = document.createElement('div'); ch.className=`checker ${type}`;
                        if(k===max-1 && num>5) {
                            const sp = document.createElement('span'); sp.className='checker-count'; sp.innerText=num; ch.appendChild(sp);
                        }
                        stack.appendChild(ch);
                    }
                    p.appendChild(stack);
                }

                // Append Logic: 
                // Ãœstler (tl, tr): DÃ¼z sÄ±ra.
                // Altlar (bl, br): Rotate 180 oldugu iÃ§in DÃœZ sÄ±ra eklersek gÃ¶rsel TERS olur.
                // Tavla'da alt sÄ±ra SaÄŸdan Sola gider (GÃ¶rsel). 
                // Flex row-reverse yaparsak: 0, 1, 2 -> GÃ¶rsel: 2, 1, 0.
                // Tavla'da saÄŸ alt 0. 
                if(tid==='br' || tid==='bl') box.style.flexDirection = 'row-reverse';
                else box.style.flexDirection = 'row';

                box.appendChild(p);
            }
            
            // Bar
            const bw=document.getElementById('bar-white'), bb=document.getElementById('bar-black');
            bw.style.display=gameState.bar.white>0?'block':'none';
            bb.style.display=gameState.bar.black>0?'block':'none';
            if(selectedIndex===99 && myColor==='white') bw.style.boxShadow='0 0 10px yellow'; else bw.style.boxShadow='';
            if(selectedIndex===99 && myColor==='black') bb.style.boxShadow='0 0 10px yellow'; else bb.style.boxShadow='';

            // Dice
            const d1=document.getElementById('die1'), d2=document.getElementById('die2');
            if(gameState.dice.length){ d1.style.display='flex'; d1.innerText=gameState.dice[0]; d2.style.display='flex'; d2.innerText=gameState.dice[1]; }
            else { d1.style.display='none'; d2.style.display='none'; }

            // Msg
            const m = document.getElementById('game-msg');
            m.innerText = gameState.msg || "";
            m.style.display = gameState.msg ? 'block' : 'none';
        }

        function updateUI() {
            const isMe = gameState.turn === myColor;
            document.getElementById('turn-msg').innerText = isMe ? "SIRA SENDE" : (gameState.turn==='white'?"SIRA BEYAZDA":"SIRA SÄ°YAHDA");
            
            const btnRoll = document.getElementById('rollBtn');
            const btnPass = document.getElementById('passBtn');
            btnRoll.style.display='none'; btnPass.style.display='none';

            if(isMe) {
                if(!gameState.dice.length) btnRoll.style.display='block';
                else if(!gameState.moves.length) btnPass.style.display='block';
            }
        }

        // --- GAME LOGIC ---
        function rollDice() {
            const d1=Math.floor(Math.random()*6)+1, d2=Math.floor(Math.random()*6)+1;
            const m = (d1===d2)?[d1,d1,d1,d1]:[d1,d2];
            db.ref(`games/${roomId}`).update({dice:[d1,d2], moves:m, msg:`${myColor==='white'?'Beyaz':'Siyah'} attÄ±: ${d1}-${d2}`});
        }

        function handleBar(c) {
            if(gameState.turn!==myColor || c!==myColor) return;
            selectedIndex=99; render();
        }

        function handleClick(i) {
            if(gameState.turn!==myColor || !gameState.moves.length) return;
            if(gameState.bar[myColor]>0 && selectedIndex!==99) { alert("Ã–nce bar!"); return; }

            const c = gameState.board[i];
            const isMine = (myColor==='white'&&c>0) || (myColor==='black'&&c<0);

            if(selectedIndex===-1) {
                if(isMine) { selectedIndex=i; render(); }
            } else {
                if(i===selectedIndex) { selectedIndex=-1; render(); return; }
                if(tryMove(selectedIndex, i)) selectedIndex=-1;
                else if(isMine) { selectedIndex=i; render(); }
            }
        }

        function checkValid(to) {
            if(selectedIndex===-1) return false;
            return canMove(selectedIndex, to);
        }

        function canMove(from, to) {
            let d;
            if(myColor==='white') d = (from===99) ? (24-to) : (from-to);
            else d = (from===99) ? (to+1) : (to-from);
            
            if(d<=0 || !gameState.moves.includes(d)) return false;
            const t = gameState.board[to];
            if(myColor==='white' && t<-1) return false;
            if(myColor==='black' && t>1) return false;
            return true;
        }

        function tryMove(from, to) {
            if(!canMove(from, to)) return false;
            let st = JSON.parse(JSON.stringify(gameState));
            
            let d = (myColor==='white') ? ((from===99)?24-to:from-to) : ((from===99)?to+1:to-from);
            st.moves.splice(st.moves.indexOf(d), 1);

            if(from===99) st.bar[myColor]--;
            else { if(myColor==='white') st.board[from]--; else st.board[from]++; }

            const t = st.board[to];
            const hit = (myColor==='white'&&t===-1)||(myColor==='black'&&t===1);
            if(hit) {
                if(myColor==='white') { st.board[to]=1; st.bar.black++; }
                else { st.board[to]=-1; st.bar.white++; }
                st.msg="KIRDI!";
            } else {
                if(myColor==='white') st.board[to]++; else st.board[to]--;
            }

            if(st.moves.length===0) {
                st.turn = (myColor==='white')?'black':'white'; st.dice=[]; st.msg="SÄ±ra geÃ§ti";
            } else st.msg="";

            db.ref(`games/${roomId}`).set(st);
            return true;
        }

        function passTurn() {
            db.ref(`games/${roomId}`).update({turn:myColor==='white'?'black':'white', dice:[], moves:[], msg:"Pas"});
        }

        // --- CHAT ---
        function toggleChat() { 
            const p=document.getElementById('chat-panel'); p.style.display=p.style.display==='flex'?'none':'flex'; 
        }
        function sendChat() {
            const i=document.getElementById('chatInput'); if(!i.value)return;
            db.ref(`games/${roomId}/chat`).push({u:myColor==='white'?'Beyaz':'Siyah', t:i.value}); i.value='';
        }
        function listenChat(){
            db.ref(`games/${roomId}/chat`).limitToLast(10).on('child_added', s=>{
                const v=s.val();
                const d=document.createElement('div'); d.className='msg-row';
                d.innerHTML=`<b>${v.u}:</b> ${v.t}`;
                document.getElementById('chat-box').appendChild(d);
            });
        }
    </script>
</body>
</html>