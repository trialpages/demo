<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÄ±ble PusulasÄ± | Dinamik YÃ¶n Bulucu</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Reset ve Temel Ayarlar */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        /* Ana Konteyner */
        #container {
            width: 90%;
            max-width: 400px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        /* BaÅŸlÄ±k */
        h1 {
            color: #1a4d3a; /* Koyu YeÅŸil */
            font-weight: 800;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        p {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 30px;
        }

        /* Pusula AlanÄ± */
        #compass-area {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border-radius: 50%;
            border: 5px solid #1a4d3a;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.1);
            background: #f0f5f0;
            /* PusulanÄ±n kendisi sabit kalacak, iÃ§indeki oklar dÃ¶necek */
        }
        
        /* Kuzey Ä°ÅŸaretÃ§isi (Mavi Ok/Ä°ÅŸaret) */
        #north-indicator {
            content: 'N';
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) rotate(0deg); /* JS ile dÃ¶ndÃ¼rÃ¼lecek */
            width: 0;
            height: 0;
            margin-left: -15px; 
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 40px solid #3498db; /* Mavi ÃœÃ§gen Ok */
            transform-origin: bottom center;
            transition: transform 0.1s linear;
            z-index: 10;
        }

        /* KÄ±ble Ä°ÅŸaretÃ§isi (KÄ±rmÄ±zÄ± Ok) */
        #qibla-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%) rotate(0deg); /* JS ile dÃ¶ndÃ¼rÃ¼lecek */
            width: 0;
            height: 0;
            margin-left: -10px; /* Daha kÃ¼Ã§Ã¼k ok */
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-bottom: 60px solid #e74c3c; /* KÄ±rmÄ±zÄ± ÃœÃ§gen Ok */
            transform-origin: bottom center;
            transition: transform 0.1s linear;
            z-index: 11; /* En Ã¼stte KÄ±ble olsun */
        }

        /* Merkez NoktasÄ± */
        #compass-area::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #1a4d3a;
            z-index: 12;
        }

        /* Durum Bilgisi */
        #status {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            min-height: 20px;
            margin-top: 15px;
        }
        
        #angle-info {
            font-size: 1.5rem;
            color: #e74c3c;
            font-weight: 700;
            margin-top: 10px;
        }
        
        /* Ä°zin Butonu */
        #permission-button {
            background-color: #1a4d3a;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: none; 
            margin-top: 20px;
            transition: background-color 0.2s;
        }
        #permission-button:hover {
            background-color: #0d3220;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>ğŸ•‹ KÄ±ble PusulasÄ±</h1>
        <p>KÄ±rmÄ±zÄ± ok kÄ±bleyi, Mavi ok Kuzey'i gÃ¶sterir. CihazÄ± dÃ¼z tutun.</p>
        
        <div id="compass-area">
            <div id="north-indicator"></div>
            <div id="qibla-indicator"></div>
        </div>

        <div id="angle-info">YÃ¶n: - | KÄ±ble AÃ§Ä±sÄ±: -</div>

        <div id="status">Konumunuz bekleniyor...</div>
        
        <button id="permission-button">Pusula Ä°zni Ver</button>
    </div>

    <script>
        // --- KÄ±ble KoordinatlarÄ± (Kabe) ---
        const KIBLA_LAT = 21.4225; 
        const KIBLA_LON = 39.8262;

        let userLat = null;
        let userLon = null;
        let qiblaDirection = null; // Kuzey'e gÃ¶re KÄ±ble'nin aÃ§Ä±sÄ±
        let compassHeading = 0; // CihazÄ±n manyetik kuzey'e gÃ¶re yÃ¶nÃ¼

        const qiblaIndicator = document.getElementById('qibla-indicator');
        const northIndicator = document.getElementById('north-indicator');
        const statusDiv = document.getElementById('status');
        const angleInfoDiv = document.getElementById('angle-info');
        const permissionButton = document.getElementById('permission-button');

        // --- 1. KÄ±ble AÃ§Ä±sÄ±nÄ± Hesaplama Fonksiyonu ---
        function calculateQibla(lat, lon) {
            const latRad = toRadians(lat);
            const lonRad = toRadians(lon);
            const kibleLatRad = toRadians(KIBLA_LAT);
            const kibleLonRad = toRadians(KIBLA_LON);

            const dLon = kibleLonRad - lonRad;

            const y = Math.sin(dLon) * Math.cos(kibleLatRad);
            const x = Math.cos(latRad) * Math.sin(kibleLatRad) - 
                      Math.sin(latRad) * Math.cos(kibleLatRad) * Math.cos(dLon);

            let bearing = toDegrees(Math.atan2(y, x));
            bearing = (bearing + 360) % 360; 
            
            return bearing;
        }

        // YardÄ±mcÄ± Fonksiyonlar
        const toRadians = (degrees) => degrees * (Math.PI / 180);
        const toDegrees = (radians) => radians * (180 / Math.PI);
        const round = (num) => Math.round(num * 10) / 10;

        // --- 2. Konum Ä°zni Alma (GPS) ---
        function getUserLocation() {
            statusDiv.innerText = "Konum verileri alÄ±nÄ±yor...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        qiblaDirection = calculateQibla(userLat, userLon);
                        
                        statusDiv.innerText = `âœ… Konum alÄ±ndÄ±. KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
                        
                        initCompassSensor(); 
                    },
                    (error) => {
                        statusDiv.innerText = "âŒ Konum izni reddedildi veya bulunamadÄ±! LÃ¼tfen sayfayÄ± HTTPS Ã¼zerinden aÃ§Ä±n ve tekrar deneyin.";
                        console.error("Geolocation Error:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                statusDiv.innerText = "âŒ CihazÄ±nÄ±z Geolocation'Ä± desteklemiyor.";
            }
        }

        // --- 3. Pusula SensÃ¶rÃ¼nÃ¼ BaÅŸlatma ---
        function initCompassSensor() {
            if (window.DeviceOrientationEvent) {
                // iOS 13+ KontrolÃ¼
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    permissionButton.style.display = 'block';
                    permissionButton.onclick = requestPermission;
                    statusDiv.innerText = "iOS: Pusula sensÃ¶rÃ¼ iÃ§in izin gerekli.";
                } else {
                    window.addEventListener('deviceorientationabsolute', handleOrientation);
                    statusDiv.innerText = `ğŸ§­ Pusula hazÄ±r. KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
                }
            } else {
                statusDiv.innerText = "âŒ CihazÄ±nÄ±z pusula sensÃ¶rÃ¼nÃ¼ desteklemiyor.";
            }
        }

        // iOS Ä°zin Ä°steme Fonksiyonu
        function requestPermission() {
             DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientationabsolute', handleOrientation);
                        permissionButton.style.display = 'none';
                        statusDiv.innerText = `ğŸ§­ Pusula hazÄ±r. KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
                    } else {
                        statusDiv.innerText = "âŒ Pusula izni verilmedi.";
                    }
                })
                .catch(error => {
                    console.error("Permission Error:", error);
                    statusDiv.innerText = "âŒ Ä°zin istenirken hata oluÅŸtu.";
                });
        }

        // --- 4. YÃ¶n DeÄŸiÅŸikliÄŸini Ä°ÅŸleme (DÄ°NAMÄ°K PUSULA) ---
        function handleOrientation(event) {
            if (qiblaDirection === null) return;

            // 'alpha' deÄŸeri cihazÄ±n Kuzey'den itibaren saat yÃ¶nÃ¼nde (0-360) olan yÃ¶nÃ¼dÃ¼r.
            compassHeading = event.alpha; 
            
            // 1. KUZEY OKUNUN DÃ–NÃœÅÃœ (Cihaz ne yÃ¶ne bakÄ±yorsa, Kuzey Oku o yÃ¶nÃ¼ gÃ¶stermelidir)
            // Ok, cihazÄ±n ters yÃ¶nÃ¼nde dÃ¶nerek Kuzey'i iÅŸaret eder.
            // Ã–rnek: Cihaz 90Â° (DoÄŸu) gÃ¶steriyorsa, Ok -90Â° dÃ¶nmelidir.
            let northRotationAngle = 360 - compassHeading;
            northIndicator.style.transform = `rotate(${northRotationAngle}deg)`;

            // 2. KIBLE OKUNUN DÃ–NÃœÅÃœ (KÄ±ble AÃ§Ä±sÄ± - CihazÄ±n YÃ¶nÃ¼)
            // KÄ±ble Oku, (Kuzey'e gÃ¶re KÄ±ble aÃ§Ä±sÄ±) - (CihazÄ±n Kuzey'e gÃ¶re yÃ¶nÃ¼) kadar dÃ¶nmelidir.
            let qiblaRotationAngle = qiblaDirection - compassHeading; 
            qiblaRotationAngle = (qiblaRotationAngle + 360) % 360; 

            qiblaIndicator.style.transform = `rotate(${qiblaRotationAngle}deg)`;

            angleInfoDiv.innerHTML = `YÃ¶n: ${round(compassHeading)}Â° | KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
            
            // KÄ±bleye olan uzaklÄ±k (0Â°'ye ne kadar yakÄ±n)
            const kÄ±bleyeUzaklÄ±k = Math.min(qiblaRotationAngle, 360 - qiblaRotationAngle);

            if (kÄ±bleyeUzaklÄ±k < 5 || kÄ±bleyeUzaklÄ±k > 355) {
                statusDiv.innerText = "â­ KÄ±ble YÃ¶nÃ¼ Bulundu! Sabit tutun. â­";
                qiblaIndicator.style.borderBottomColor = '#27ae60'; // YeÅŸil yap
            } else {
                statusDiv.innerText = "CihazÄ± KÄ±bleye dÃ¶ndÃ¼rÃ¼n.";
                qiblaIndicator.style.borderBottomColor = '#e74c3c'; // KÄ±rmÄ±zÄ± yap
            }
        }

        // --- 5. BaÅŸlangÄ±Ã§ ---
        getUserLocation();
    </script>
</body>
</html>
