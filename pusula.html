<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KÄ±ble PusulasÄ± | YÃ¶n Bulucu</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&display=swap" rel="stylesheet">
    
    <style>
        /* CSS Reset ve Temel Ayarlar */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Montserrat', sans-serif;
            background-color: #f8f8f8;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
        }

        /* Ana Konteyner */
        #container {
            width: 90%;
            max-width: 400px;
            padding: 30px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        /* BaÅŸlÄ±k */
        h1 {
            color: #1a4d3a; /* Koyu YeÅŸil */
            font-weight: 800;
            margin-bottom: 5px;
            font-size: 1.8rem;
        }
        
        p {
            font-size: 0.9rem;
            color: #777;
            margin-bottom: 30px;
        }

        /* Pusula AlanÄ± */
        #compass-area {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 0 auto 30px;
            border-radius: 50%;
            border: 5px solid #1a4d3a;
            box-shadow: inset 0 0 15px rgba(0, 0, 0, 0.1), 0 5px 15px rgba(0, 0, 0, 0.1);
            background: #f0f5f0;
        }

        /* KÄ±ble Ä°ÅŸaretÃ§isi (KÄ±rmÄ±zÄ± Ok) */
        #qibla-indicator {
            position: absolute;
            top: 0;
            left: 50%;
            width: 0;
            height: 0;
            margin-left: -15px; /* YarÄ±m geniÅŸlik kadar sola kaydÄ±r */
            border-left: 15px solid transparent;
            border-right: 15px solid transparent;
            border-bottom: 40px solid #e74c3c; /* KÄ±rmÄ±zÄ± ÃœÃ§gen Ok */
            transform-origin: bottom center;
            transition: transform 0.1s linear; /* YumuÅŸak DÃ¶nÃ¼ÅŸ */
            z-index: 10;
        }

        /* Pusula Ã‡emberi Ä°Ã§indeki Merkez NoktasÄ± */
        #compass-area::before {
            content: 'N';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-weight: 800;
            color: #1a4d3a;
        }

        /* Durum Bilgisi */
        #status {
            font-size: 1rem;
            font-weight: 600;
            color: #333;
            min-height: 20px;
            margin-top: 15px;
        }
        
        #angle-info {
            font-size: 1.5rem;
            color: #e74c3c;
            font-weight: 700;
            margin-top: 10px;
        }
        
        /* Ä°zin Butonu (Gerekirse) */
        #permission-button {
            background-color: #1a4d3a;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            display: none; /* JS ile gÃ¶sterilecek */
            margin-top: 20px;
            transition: background-color 0.2s;
        }
        #permission-button:hover {
            background-color: #0d3220;
        }

        /* Footer */
        .footer {
            margin-top: 20px;
            font-size: 0.75rem;
            color: #aaa;
        }
    </style>
</head>
<body>

    <div id="container">
        <h1>ğŸ•‹ KÄ±ble PusulasÄ±</h1>
        <p>DoÄŸru kÄ±ble yÃ¶nÃ¼nÃ¼ bulmak iÃ§in cihazÄ±nÄ±zÄ± dÃ¼z tutun.</p>
        
        <div id="compass-area">
            <div id="qibla-indicator" style="transform: rotate(0deg);"></div>
        </div>

        <div id="angle-info">YÃ¶n: 0Â° | KÄ±ble AÃ§Ä±sÄ±: -</div>

        <div id="status">Konumunuz bekleniyor...</div>
        
        <button id="permission-button">Pusula Ä°zni Ver</button>
    </div>
    
    <div class="footer">
        * Bu araÃ§, cihazÄ±nÄ±zÄ±n GPS ve manyetik sensÃ¶r verilerini kullanÄ±r.
    </div>

    <script>
        // --- KÄ±ble KoordinatlarÄ± (Kabe) ---
        const KIBLA_LAT = 21.4225; 
        const KIBLA_LON = 39.8262;

        let userLat = null;
        let userLon = null;
        let qiblaDirection = null; // KullanÄ±cÄ±nÄ±n konumundan KÄ±bleye olan aÃ§Ä±
        let compassHeading = 0; // CihazÄ±n Kuzey'e gÃ¶re manyetik yÃ¶nÃ¼

        const indicator = document.getElementById('qibla-indicator');
        const statusDiv = document.getElementById('status');
        const angleInfoDiv = document.getElementById('angle-info');
        const permissionButton = document.getElementById('permission-button');

        // --- 1. KÄ±ble AÃ§Ä±sÄ±nÄ± Hesaplama Fonksiyonu (HaritacÄ±lÄ±k FormÃ¼lÃ¼) ---
        function calculateQibla(lat, lon) {
            // Dereceyi radyana Ã§evir
            const latRad = toRadians(lat);
            const lonRad = toRadians(lon);
            const kibleLatRad = toRadians(KIBLA_LAT);
            const kibleLonRad = toRadians(KIBLA_LON);

            const dLon = kibleLonRad - lonRad;

            // FormÃ¼l: Bearing = atan2(sin(Î”Î») * cos(Ï†2), cos(Ï†1) * sin(Ï†2) - sin(Ï†1) * cos(Ï†2) * cos(Î”Î»))
            const y = Math.sin(dLon) * Math.cos(kibleLatRad);
            const x = Math.cos(latRad) * Math.sin(kibleLatRad) - 
                      Math.sin(latRad) * Math.cos(kibleLatRad) * Math.cos(dLon);

            let bearing = toDegrees(Math.atan2(y, x));

            // AÃ§Ä± 0 ile 360 derece arasÄ±na dÃ¶nÃ¼ÅŸtÃ¼rÃ¼lÃ¼r (Kuzey=0, DoÄŸu=90)
            bearing = (bearing + 360) % 360; 
            
            return bearing;
        }

        // YardÄ±mcÄ± Fonksiyonlar
        const toRadians = (degrees) => degrees * (Math.PI / 180);
        const toDegrees = (radians) => radians * (180 / Math.PI);
        const round = (num) => Math.round(num * 10) / 10;

        // --- 2. Konum Ä°zni Alma (GPS) ---
        function getUserLocation() {
            statusDiv.innerText = "Konum verileri alÄ±nÄ±yor...";
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        userLat = position.coords.latitude;
                        userLon = position.coords.longitude;
                        qiblaDirection = calculateQibla(userLat, userLon);
                        
                        statusDiv.innerText = `âœ… Konum: ${round(userLat)}Â°, ${round(userLon)}Â°`;
                        
                        // Konum alÄ±ndÄ±ktan sonra pusula sensÃ¶rÃ¼nÃ¼ baÅŸlat
                        initCompassSensor(); 
                    },
                    (error) => {
                        statusDiv.innerText = "âŒ Konum izni reddedildi veya bulunamadÄ±! LÃ¼tfen tekrar deneyin.";
                        console.error("Geolocation Error:", error);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                statusDiv.innerText = "âŒ CihazÄ±nÄ±z Geolocation'Ä± desteklemiyor.";
            }
        }

        // --- 3. Pusula SensÃ¶rÃ¼nÃ¼ BaÅŸlatma (Cihaz YÃ¶nÃ¼) ---
        function initCompassSensor() {
            if (window.DeviceOrientationEvent) {
                // iOS 13+ GÃ¼venlik KontrolÃ¼: Ä°zin butonu gereklidir.
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    permissionButton.style.display = 'block';
                    permissionButton.onclick = requestPermission;
                    statusDiv.innerText = "iOS GÃ¼venliÄŸi: Pusula iÃ§in izin gerekli.";
                } else {
                    // Android ve eski iOS cihazlar
                    window.addEventListener('deviceorientationabsolute', handleOrientation);
                    statusDiv.innerText = `ğŸ§­ Pusula baÅŸlatÄ±ldÄ±. KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
                }
            } else {
                statusDiv.innerText = "âŒ CihazÄ±nÄ±z pusula sensÃ¶rÃ¼nÃ¼ desteklemiyor.";
            }
        }

        // iOS Ä°zin Ä°steme Fonksiyonu
        function requestPermission() {
             DeviceOrientationEvent.requestPermission()
                .then(response => {
                    if (response === 'granted') {
                        window.addEventListener('deviceorientationabsolute', handleOrientation);
                        permissionButton.style.display = 'none';
                        statusDiv.innerText = `ğŸ§­ Pusula baÅŸlatÄ±ldÄ±. KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
                    } else {
                        statusDiv.innerText = "âŒ Pusula izni verilmedi.";
                    }
                })
                .catch(error => {
                    console.error("Permission Error:", error);
                    statusDiv.innerText = "âŒ Ä°zin istenirken hata oluÅŸtu.";
                });
        }

        // --- 4. YÃ¶n DeÄŸiÅŸikliÄŸini Ä°ÅŸleme ---
        function handleOrientation(event) {
            if (qiblaDirection === null) return;

            // 'alpha' deÄŸeri Kuzey'den (0Â°) itibaren saat yÃ¶nÃ¼nde cihazÄ±n yÃ¶nÃ¼nÃ¼ verir (0-360)
            // Bu deÄŸer manyetik kuzeydir (Ã§oÄŸu cihazda manyetik kuzeye gÃ¶re ayar yaparÄ±z)
            compassHeading = event.alpha; 
            
            // KÄ±ble yÃ¶nÃ¼ = (CihazÄ±n Kuzey'e gÃ¶re yÃ¶nÃ¼) - (Kuzey'e gÃ¶re KÄ±ble aÃ§Ä±sÄ±)
            // Ya da tam tersi: KÄ±ble Okunun YÃ¶nÃ¼ = KÄ±ble AÃ§Ä±sÄ± - CihazÄ±n YÃ¶nÃ¼
            
            // Bu, cihazÄ±n kuzeyden sapma aÃ§Ä±sÄ±dÄ±r.
            let deviceRotation = 360 - compassHeading; 
            
            // KÄ±ble Okunun DÃ¶nÃ¼ÅŸ AÃ§Ä±sÄ±: (KÄ±bleye olan aÃ§Ä±) - (CihazÄ±n Kuzeye gÃ¶re yÃ¶nÃ¼)
            // EÄŸer sonuÃ§ negatifse, 360 eklenerek 0-360 arasÄ±na Ã§ekilir.
            let rotationAngle = qiblaDirection - compassHeading; 
            
            // Okun dÃ¶nÃ¼ÅŸ aÃ§Ä±sÄ± (KÄ±ble her zaman 0 derecede yukarÄ±yÄ± gÃ¶steriyor gibi dÃ¼ÅŸÃ¼nÃ¼lÃ¼r)
            rotationAngle = (rotationAngle + 360) % 360; 

            // Okun dÃ¶nÃ¼ÅŸ aÃ§Ä±sÄ±nÄ± uygula (Cihaz dÃ¶ndÃ¼kÃ§e ok sabit bir yÃ¶ne dÃ¶ner)
            indicator.style.transform = `rotate(${rotationAngle}deg)`;

            angleInfoDiv.innerHTML = `YÃ¶n: ${round(compassHeading)}Â° | KÄ±ble AÃ§Ä±sÄ±: ${round(qiblaDirection)}Â°`;
            
            // CihazÄ±n kuzeye gÃ¶re sapmasÄ± 5 derece iÃ§indeyse, KÄ±bleye dÃ¶nmÃ¼ÅŸ demektir.
            const kÄ±bleyeUzaklÄ±k = Math.min(rotationAngle, 360 - rotationAngle);

            if (kÄ±bleyeUzaklÄ±k < 5 || kÄ±bleyeUzaklÄ±k > 355) {
                statusDiv.innerText = "â­ KÄ±ble YÃ¶nÃ¼ Bulundu! â­";
                indicator.style.borderBottomColor = '#27ae60'; // YeÅŸil yap
            } else {
                statusDiv.innerText = "CihazÄ± KÄ±bleye dÃ¶ndÃ¼rÃ¼n.";
                indicator.style.borderBottomColor = '#e74c3c'; // KÄ±rmÄ±zÄ± yap
            }
        }

        // --- 5. BaÅŸlangÄ±Ã§ ---
        getUserLocation();
    </script>
</body>
</html>
