<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Serverless P2P Chat</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #222; color: #0f0; }
        .box { border: 1px solid #444; padding: 15px; margin-bottom: 20px; background: #000; }
        textarea { width: 100%; height: 60px; background: #111; color: #ddd; border: 1px solid #555; }
        input { width: 70%; padding: 5px; background: #111; color: #fff; border: 1px solid #555; }
        button { padding: 5px 15px; cursor: pointer; background: #004400; color: #fff; border: none; font-weight: bold; }
        button:hover { background: #006600; }
        #logs { height: 200px; overflow-y: scroll; border: 1px dashed #333; padding: 5px; color: #aaa; font-size: 12px;}
        .msg { color: #fff; margin: 5px 0; border-bottom: 1px solid #333; padding: 2px; }
        .me { color: #0ff; } .peer { color: #f0f; }
        h3 { margin-top: 0; border-bottom: 1px solid #444; padding-bottom: 5px; }
    </style>
</head>
<body>

    <h2>ğŸ•µï¸â€â™‚ï¸ Sunucusuz P2P Chat (WebRTC)</h2>
    <div style="color:#aaa; font-size:12px; margin-bottom:15px;">
        MantÄ±k: 1. Taraf 'Teklif OluÅŸtur' der. Ã‡Ä±kan kodu 2. Tarafa atar. <br>
        2. Taraf kodu yapÄ±ÅŸtÄ±rÄ±p 'Cevap OluÅŸtur' der. Ã‡Ä±kan kodu 1. Tarafa atar. BaÄŸlantÄ± kurulur.
    </div>

    <div class="box" id="setupPanel">
        <h3>1. BaÄŸlantÄ± AyarlarÄ± (El SÄ±kÄ±ÅŸma)</h3>
        
        <p>Sen baÅŸlatÄ±yorsan tÄ±kla (Teklif OluÅŸtur):</p>
        <button onclick="createOffer()">Teklif OluÅŸtur (Ben BaÅŸlatÄ±yorum)</button>
        
        <p>Veya karÅŸÄ±dan gelen kodu buraya yapÄ±ÅŸtÄ±r:</p>
        <textarea id="remoteSdp" placeholder="KarÅŸÄ± tarafÄ±n kodunu buraya yapÄ±ÅŸtÄ±r..."></textarea>
        <br><br>
        <button onclick="acceptRemote()">Kodu Kabul Et & Cevap Ãœret</button>
        
        <p>Senin Kodun (Bunu arkadaÅŸÄ±na gÃ¶nder):</p>
        <textarea id="localSdp" readonly placeholder="Burada senin kodun oluÅŸacak..."></textarea>
    </div>

    <div class="box" id="chatPanel" style="opacity: 0.5; pointer-events: none;">
        <h3>2. Sohbet KanalÄ± (GÃ¼venli & Direkt)</h3>
        <div id="logs"></div>
        <div style="margin-top:10px;">
            <input type="text" id="msgInput" placeholder="MesajÄ±n..." onkeypress="if(event.key==='Enter') sendMsg()">
            <button onclick="sendMsg()">GÃ–NDER</button>
        </div>
    </div>

<script>
    const config = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] }; // Google'Ä±n Ã¼cretsiz STUN sunucusu (Sadece IP bulmak iÃ§in)
    const pc = new RTCPeerConnection(config);
    let dataChannel;

    // Loglama fonksiyonu
    function log(msg, type = 'sys') {
        const logs = document.getElementById('logs');
        const color = type === 'me' ? 'me' : (type === 'peer' ? 'peer' : '');
        logs.innerHTML += `<div class="msg ${color}">${type === 'sys' ? '> ' : ''}${msg}</div>`;
        logs.scrollTop = logs.scrollHeight;
    }

    // 1. Veri KanalÄ± OluÅŸturma (BaÅŸlatan taraf iÃ§in)
    function createOffer() {
        dataChannel = pc.createDataChannel("chat");
        setupChannel(dataChannel);
        
        pc.createOffer()
            .then(offer => pc.setLocalDescription(offer))
            .then(() => log("Teklif oluÅŸturuldu! AÅŸaÄŸÄ±daki kodu kopyalayÄ±p arkadaÅŸÄ±na gÃ¶nder."));
    }

    // 2. Gelen Kodu Ä°ÅŸleme (Her iki taraf iÃ§in)
    async function acceptRemote() {
        const remoteDesc = document.getElementById('remoteSdp').value;
        if (!remoteDesc) return alert("LÃ¼tfen karÅŸÄ± tarafÄ±n kodunu yapÄ±ÅŸtÄ±rÄ±n!");
        
        const desc = new RTCSessionDescription(JSON.parse(remoteDesc));
        await pc.setRemoteDescription(desc);
        
        if (pc.remoteDescription.type === "offer") {
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            log("Cevap oluÅŸturuldu! 'Senin Kodun' kÄ±smÄ±ndaki kodu kopyalayÄ±p baÅŸlatan kiÅŸiye geri gÃ¶nder.");
        }
    }

    // ICE Candidate (BaÄŸlantÄ± adaylarÄ±) oluÅŸtuÄŸunda tetiklenir
    pc.onicecandidate = e => {
        if (e.candidate === null) {
            // TÃ¼m adaylar toplandÄ±, SDP hazÄ±r.
            document.getElementById('localSdp').value = JSON.stringify(pc.localDescription);
            document.getElementById('localSdp').select();
        }
    };

    // BaÄŸlantÄ± durumu deÄŸiÅŸtiÄŸinde
    pc.onconnectionstatechange = () => {
        log(`BaÄŸlantÄ± durumu: ${pc.connectionState}`);
        if (pc.connectionState === 'connected') {
            document.getElementById('setupPanel').style.display = 'none';
            document.getElementById('chatPanel').style.opacity = '1';
            document.getElementById('chatPanel').style.pointerEvents = 'all';
            log("âœ… BAÄLANTI BAÅARILI! GÃ¼venle konuÅŸabilirsiniz.");
        }
    };

    // KarÅŸÄ± taraf veri kanalÄ± aÃ§tÄ±ÄŸÄ±nda (Cevap veren taraf iÃ§in)
    pc.ondatachannel = e => {
        dataChannel = e.channel;
        setupChannel(dataChannel);
    };

    // Kanal ayarlarÄ± ve olaylarÄ±
    function setupChannel(channel) {
        channel.onopen = () => log("Kanal AÃ§Ä±ldÄ±!");
        channel.onmessage = e => log(e.data, 'peer');
    }

    // Mesaj GÃ¶nderme
    function sendMsg() {
        const input = document.getElementById('msgInput');
        const msg = input.value;
        if (!msg || !dataChannel) return;
        
        dataChannel.send(msg);
        log(msg, 'me');
        input.value = '';
    }
</script>
</body>
</html>
