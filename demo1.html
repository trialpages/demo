<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Sohbet Sayfasƒ±</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <style>
    body {
      font-family: sans-serif;
      max-width: 600px;
      margin: 40px auto;
      padding: 20px;
      background: #f4f4f4;
      border-radius: 10px;
    }
    #messages {
      max-height: 400px;
      overflow-y: auto;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      margin-bottom: 20px;
    }
    .message {
      padding: 8px;
      margin-bottom: 10px;
      border-radius: 4px;
      background: #e9e9ff;
    }
    .media {
      max-width: 100%;
      margin-top: 8px;
    }
    input, button {
      padding: 8px;
      margin-top: 6px;
      font-size: 1em;
    }
  </style>
</head>
<body>

  <h2>üì® Supabase Sohbet</h2>

  <div id="messages"></div>

  <input type="text" id="textInput" placeholder="Mesaj yaz..." style="width: 100%;" />
  <input type="file" id="fileInput" style="margin-top: 10px;" />
  <br>
  <button onclick="sendMessage()">G√∂nder</button>

  <script>
    const supabaseUrl = 'https://vixwmuizdqotnaqhngtc.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZpeHdtdWl6ZHFvdG5hcWhuZ3RjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU1NTcwOTYsImV4cCI6MjA3MTEzMzA5Nn0.FsFWTKMaxO8JxmiOBY8EsDIY1vhraLBPVBoDrkzxWAw';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    // Mesajlarƒ± √ßek ve g√∂ster
    async function loadMessages() {
      const { data, error } = await supabase
        .from('messages')
        .select('*')
        .order('created_at', { ascending: true });

      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML = '';

      data.forEach(msg => {
        const div = document.createElement('div');
        div.className = 'message';

        if (msg.message) {
          div.innerHTML = `<strong>üìù</strong> ${msg.message}`;
        }

        if (msg.media_url && msg.media_type) {
          if (msg.media_type === 'image') {
            div.innerHTML += `<br><img src="${msg.media_url}" class="media">`;
          } else if (msg.media_type === 'audio') {
            div.innerHTML += `<br><audio controls src="${msg.media_url}" class="media"></audio>`;
          } else {
            div.innerHTML += `<br><a href="${msg.media_url}" target="_blank">üìé Dosya A√ß</a>`;
          }
        }

        messagesDiv.appendChild(div);
      });

      // Scroll to bottom
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Mesaj g√∂nder
    async function sendMessage() {
      const text = document.getElementById('textInput').value.trim();
      const fileInput = document.getElementById('fileInput');
      const file = fileInput.files[0];

      let mediaUrl = null;
      let mediaType = null;

      if (file) {
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}.${fileExt}`;
        const filePath = `uploads/${fileName}`;

        const { error: uploadError } = await supabase
          .storage
          .from('messages')
          .upload(filePath, file);

        if (uploadError) {
          alert('Dosya y√ºkleme hatasƒ±: ' + uploadError.message);
          return;
        }

        const { data: urlData } = supabase
          .storage
          .from('messages')
          .getPublicUrl(filePath);

        mediaUrl = urlData.publicUrl;

        // Dosya tipini belirle
        if (file.type.startsWith('image/')) {
          mediaType = 'image';
        } else if (file.type.startsWith('audio/')) {
          mediaType = 'audio';
        } else {
          mediaType = 'file';
        }
      }

      if (!text && !mediaUrl) {
        alert('Bo≈ü mesaj g√∂nderilemez.');
        return;
      }

      const { error: dbError } = await supabase
        .from('messages')
        .insert([{
          message: text || null,
          media_url: mediaUrl,
          media_type: mediaType,
          created_at: new Date().toISOString()
        }]);

      if (dbError) {
        alert('Mesaj g√∂nderme hatasƒ±: ' + dbError.message);
      }

      document.getElementById('textInput').value = '';
      fileInput.value = '';
      loadMessages();
    }

    // Sayfa y√ºklenince mesajlarƒ± getir
    loadMessages();
  </script>

</body>
</html>