<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Void Link | Video & Chat</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --danger: #ef4444;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --mine-bubble: #6366f1;
            --peer-bubble: #334155;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: system-ui, -apple-system, sans-serif;
            background-color: var(--bg); color: var(--text);
            height: 100dvh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: absolute; inset: 0; background: var(--bg); z-index: 100;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px; transition: transform 0.4s ease-in-out;
        }
        #login-screen.hidden { transform: translateY(-100%); }

        .brand-title {
            font-size: 2.2rem; font-weight: 800;
            background: linear-gradient(135deg, #a5b4fc, #6366f1);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            margin-bottom: 40px; letter-spacing: -1px;
        }

        .action-card {
            background: var(--surface); padding: 30px; border-radius: 24px;
            width: 100%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }

        .btn-main {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            font-size: 1rem; font-weight: 600; cursor: pointer; margin-bottom: 12px;
            background: var(--primary); color: white; display: flex; justify-content: center; gap: 10px;
        }
        .btn-main:active { transform: scale(0.98); }

        #share-modal { display: none; margin-top: 20px; background: rgba(0,0,0,0.2); padding: 15px; border-radius: 12px; }
        .share-link-box { background: var(--bg); padding: 12px; border-radius: 8px; font-family: monospace; color: var(--text-muted); font-size: 0.85rem; word-break: break-all; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }

        /* --- CHAT INTERFACE --- */
        header {
            height: 60px; padding: 0 20px; background: rgba(30, 41, 59, 0.95);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; z-index: 10;
        }

        .header-actions { display: flex; gap: 15px; }
        .icon-btn-header { background: none; border: none; color: var(--text); cursor: pointer; padding: 8px; border-radius: 50%; transition: 0.2s; }
        .icon-btn-header:hover { background: rgba(255,255,255,0.1); }
        .icon-btn-header.call-btn { color: #10b981; background: rgba(16, 185, 129, 0.1); }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        
        .msg { max-width: 80%; padding: 10px 16px; border-radius: 18px; font-size: 0.95rem; line-height: 1.5; word-wrap: break-word; }
        .msg.me { align-self: flex-end; background: var(--mine-bubble); color: white; border-bottom-right-radius: 4px; }
        .msg.peer { align-self: flex-start; background: var(--peer-bubble); color: var(--text); border-bottom-left-radius: 4px; }
        .msg.sys { align-self: center; background: rgba(255,255,255,0.05); color: var(--text-muted); font-size: 0.75rem; padding: 4px 12px; border-radius: 20px; }

        #input-area { padding: 10px 15px; background: var(--surface); display: flex; gap: 10px; border-top: 1px solid rgba(255,255,255,0.1); padding-bottom: max(10px, env(safe-area-inset-bottom)); }
        #msg-input { flex: 1; background: var(--bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 22px; padding: 12px 16px; color: white; font-size: 1rem; max-height: 100px; outline: none; resize: none; }
        .round-btn { width: 44px; height: 44px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }

        /* --- VIDEO CALL OVERLAY --- */
        #video-overlay {
            position: fixed; inset: 0; background: #000; z-index: 50;
            display: none; flex-direction: column;
        }
        #video-overlay.active { display: flex; }

        /* Remote Video (Full Screen) */
        #remote-video { width: 100%; height: 100%; object-fit: cover; }
        
        /* Local Video (PiP) */
        #local-video {
            position: absolute; bottom: 100px; right: 20px;
            width: 120px; height: 160px; object-fit: cover;
            border-radius: 12px; border: 2px solid rgba(255,255,255,0.2);
            background: #111; box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            transition: 0.3s;
        }

        /* Call Controls */
        .call-controls {
            position: absolute; bottom: 30px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            padding-bottom: env(safe-area-inset-bottom);
        }
        .control-btn {
            width: 60px; height: 60px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px);
            color: white; font-size: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .control-btn:active { transform: scale(0.9); }
        .btn-end { background: var(--danger); }
        .control-btn.off { background: white; color: black; } /* Muted state */

        /* Incoming Call Modal */
        #incoming-call-modal {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(30, 41, 59, 0.95); backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: 50px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.1);
            display: none; align-items: center; gap: 20px; z-index: 60; animation: slideDown 0.5s ease;
        }
        @keyframes slideDown { from { transform: translate(-50%, -100%); } to { transform: translate(-50%, 0); } }

        /* File Card */
        .file-card { display: flex; align-items: center; gap: 12px; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 12px; margin-top: 4px; }
        .download-btn { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 4px; color: white; text-decoration: none; font-size: 0.8rem; display: inline-block; margin-top: 5px;}
        
        #progress-bar { position: absolute; top: 0; left: 0; width: 0%; height: 3px; background: #10b981; z-index: 200; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="progress-bar"></div>

    <div id="login-screen">
        <div class="brand-title">Void Link</div>
        <div class="action-card">
            <p style="color:var(--text-muted); margin-bottom: 20px;">G√∂r√ºnt√ºl√º, Sesli, Yazƒ±lƒ±. <br> Tamamen P2P.</p>
            <button class="btn-main" onclick="createRoom()">
                <span>üîó Link Olu≈ütur</span>
            </button>
            <div id="share-modal">
                <p style="font-size:0.9rem; margin-bottom:10px;">Linki arkada≈üƒ±na g√∂nder:</p>
                <div class="share-link-box" id="share-link-text">...</div>
                <button class="btn-main" style="background:var(--surface-light); padding: 10px;" onclick="copyLink()">Kopyala</button>
                <p style="font-size:0.8rem; color:var(--primary); margin-top:10px;">Bekleniyor...</p>
            </div>
            <div id="joining-state" style="display:none; color:var(--text-muted);">Baƒülanƒ±yor...</div>
        </div>
    </div>

    <header>
        <div style="font-weight:700;">Void Chat</div>
        <div class="header-actions">
            <button class="icon-btn-header call-btn" onclick="startCall()" title="G√∂r√ºnt√ºl√º Arama">
                üìπ
            </button>
            <button class="icon-btn-header" onclick="location.href=location.pathname" title="√áƒ±kƒ±≈ü">
                ‚ùå
            </button>
        </div>
    </header>

    <div id="messages"></div>

    <div id="input-area">
        <input type="file" id="file-input" hidden onchange="uploadFile()">
        <button class="round-btn" style="background:var(--surface-light); color:var(--text-muted);" onclick="document.getElementById('file-input').click()">üìé</button>
        <textarea id="msg-input" placeholder="Mesaj..." rows="1" oninput="this.style.height='auto';this.style.height=this.scrollHeight+'px'"></textarea>
        <button class="round-btn" style="background:var(--primary); color:white;" onclick="sendMessage()">‚û§</button>
    </div>

    <div id="video-overlay">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay playsinline muted></video>
        
        <div class="call-controls">
            <button class="control-btn" onclick="toggleMute(this)">üé§</button>
            <button class="control-btn btn-end" onclick="endCall()">üìû</button>
            <button class="control-btn" onclick="toggleCamera(this)">üì∑</button>
        </div>
    </div>

    <div id="incoming-call-modal">
        <span>üìû Gelen Arama...</span>
        <button class="round-btn" style="background:#10b981; color:white;" onclick="answerCall()">‚úî</button>
        <button class="round-btn" style="background:#ef4444; color:white;" onclick="rejectCall()">‚úñ</button>
    </div>

<script>
    // --- VARIABLES ---
    let peer = null;
    let conn = null;      // Data Connection (Chat)
    let call = null;      // Media Connection (Video)
    let localStream = null;
    const CHUNK_SIZE = 16384;

    // --- INIT ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const joinId = urlParams.get('join');
        if (joinId) {
            document.querySelector('.btn-main').style.display = 'none';
            document.getElementById('joining-state').style.display = 'block';
            joinRoom(joinId);
        }
    };

    // --- CONNECTION LOGIC ---
    function createRoom() {
        peer = new Peer(); // Kendi sunucun varsa: new Peer({host:..., port:..., secure:true})
        peer.on('open', (id) => {
            document.querySelector('.btn-main').style.display = 'none';
            document.getElementById('share-modal').style.display = 'block';
            document.getElementById('share-link-text').innerText = `${window.location.origin}${window.location.pathname}?join=${id}`;
            
            peer.on('connection', c => { conn = c; setupChat(); });
            peer.on('call', incoming => handleIncomingCall(incoming));
        });
    }

    function joinRoom(destId) {
        peer = new Peer();
        peer.on('open', () => {
            conn = peer.connect(destId);
            conn.on('open', setupChat);
            peer.on('call', incoming => handleIncomingCall(incoming));
        });
        peer.on('error', () => { alert("Baƒülantƒ± hatasƒ±!"); location.href=location.pathname; });
    }

    function setupChat() {
        document.getElementById('login-screen').classList.add('hidden');
        addSystemMessage("Baƒülantƒ± kuruldu. Kamera ikonuna basarak arayabilirsin.");
        
        conn.on('data', handleData);
        conn.on('close', () => { 
            addSystemMessage("Baƒülantƒ± koptu."); 
            endCall(true); 
        });
    }

    // --- VIDEO CALL LOGIC ---

    async function startCall() {
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            showVideoUI();
            
            // Arkada≈üƒ±nƒ± ara
            call = peer.call(conn.peer, localStream);
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            
            call.on('close', () => endCall(true));

        } catch (err) {
            alert("Kamera/Mikrofon izni verilmedi: " + err);
        }
    }

    // Gelen aramayƒ± y√∂net
    function handleIncomingCall(incoming) {
        call = incoming;
        document.getElementById('incoming-call-modal').style.display = 'flex';
    }

    async function answerCall() {
        document.getElementById('incoming-call-modal').style.display = 'none';
        try {
            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            showVideoUI();
            
            call.answer(localStream); // Cevap ver ve g√∂r√ºnt√ºn√º g√∂nder
            
            call.on('stream', remoteStream => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });

            call.on('close', () => endCall(true));

        } catch (err) { alert("ƒ∞zin hatasƒ±: " + err); }
    }

    function rejectCall() {
        document.getElementById('incoming-call-modal').style.display = 'none';
        if(call) call.close();
        conn.send({ type: 'sys', content: 'Arama reddedildi.' });
    }

    function endCall(isRemote = false) {
        if (!isRemote && call) call.close();
        
        // UI Kapat
        document.getElementById('video-overlay').classList.remove('active');
        
        // Kamerayƒ± durdur
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        
        call = null;
    }

    function showVideoUI() {
        document.getElementById('video-overlay').classList.add('active');
        document.getElementById('local-video').srcObject = localStream;
    }

    function toggleMute(btn) {
        const audioTrack = localStream.getAudioTracks()[0];
        audioTrack.enabled = !audioTrack.enabled;
        btn.classList.toggle('off');
        btn.innerText = audioTrack.enabled ? 'üé§' : 'üîá';
    }

    function toggleCamera(btn) {
        const videoTrack = localStream.getVideoTracks()[0];
        videoTrack.enabled = !videoTrack.enabled;
        btn.classList.toggle('off');
    }

    // --- CHAT & FILE LOGIC (√ñncekiyle Aynƒ±) ---
    function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if(!text || !conn) return;
        conn.send({ type: 'text', content: text });
        addMessage(text, 'me');
        input.value = '';
    }

    let incomingFile = { buffer: [], meta: null, received: 0 };

    function uploadFile() {
        const file = document.getElementById('file-input').files[0];
        if(!file || !conn) return;
        addMessage(`Dosya: ${file.name}`, 'me');
        conn.send({ type: 'file-meta', name: file.name, size: file.size, mime: file.type });
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const buffer = e.target.result;
            let offset = 0;
            const pb = document.getElementById('progress-bar');
            while(offset < buffer.byteLength) {
                conn.send({ type: 'file-chunk', data: buffer.slice(offset, offset + CHUNK_SIZE) });
                offset += CHUNK_SIZE;
                pb.style.width = (offset/buffer.byteLength)*100 + '%';
                if(offset % (CHUNK_SIZE*50) === 0) await new Promise(r=>setTimeout(r, 10));
            }
            conn.send({ type: 'file-end' });
            pb.style.width = '0%';
        };
        reader.readAsArrayBuffer(file);
    }

    function handleData(data) {
        if(data.type === 'text') addMessage(data.content, 'peer');
        else if(data.type === 'sys') addSystemMessage(data.content);
        else if(data.type === 'file-meta') {
            incomingFile = { meta: data, buffer: [], received: 0 };
            addSystemMessage(`Dosya geliyor: ${data.name}`);
        }
        else if(data.type === 'file-chunk') {
            incomingFile.buffer.push(data.data);
            incomingFile.received += data.data.byteLength;
            document.getElementById('progress-bar').style.width = (incomingFile.received/incomingFile.meta.size)*100 + '%';
        }
        else if(data.type === 'file-end') {
            const blob = new Blob(incomingFile.buffer, { type: incomingFile.meta.mime });
            renderFileLink(incomingFile.meta.name, incomingFile.meta.size, URL.createObjectURL(blob));
            document.getElementById('progress-bar').style.width = '0%';
        }
    }

    function addMessage(text, type) {
        const d = document.createElement('div'); d.className = `msg ${type}`; d.innerText = text;
        const c = document.getElementById('messages'); c.appendChild(d); c.scrollTop = c.scrollHeight;
    }
    function addSystemMessage(text) {
        const d = document.createElement('div'); d.className = 'msg sys'; d.innerText = text;
        document.getElementById('messages').appendChild(d);
    }
    function renderFileLink(name, size, url) {
        const d = document.createElement('div'); d.className = 'msg peer';
        d.innerHTML = `<div class="file-card"><div style="font-size:20px">üìÑ</div><div><div style="font-weight:bold">${name}</div><div style="font-size:0.8em">${(size/1024/1024).toFixed(2)} MB</div></div></div><a href="${url}" download="${name}" class="download-btn">‚¨á ƒ∞ndir</a>`;
        document.getElementById('messages').appendChild(d);
    }
    function copyLink() {
        navigator.clipboard.writeText(document.getElementById('share-link-text').innerText);
        alert("Kopyalandƒ±!");
    }
</script>
</body>
</html>
