<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>İletişim Formu</title>
<style>
:root {
  --primary: #4a69bd;
  --primary-hover: #3b5399;
  --bg: #f5f6fa;
  --msg-bg: #f1f2f6;
  --other: #dfe4ea;
  --danger: #e74c3c;
  --danger-hover: #c0392b;
  --radius: 12px;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background:var(--bg);}
body{display:flex;align-items:center;justify-content:center;}
.container{
  width:100%; max-width:480px; height:100dvh;
  background:#fff; display:flex; flex-direction:column;
  box-shadow:0 4px 20px rgba(0,0,0,0.12);
  position:relative;
}
header{
  background:var(--primary); color:#fff;
  padding:14px 50px 14px 16px; text-align:center; font-size:18px; font-weight:500;
  flex-shrink:0; position:relative;
}
input,textarea,button{border-radius:var(--radius);border:1px solid #ccc;font-size:14px;}
input,textarea{width:100%; padding:10px; margin:8px 0; background:#fff;}
textarea{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;resize:none;min-height:42px; max-height:140px;}
button{background:var(--primary);color:#fff;padding:10px;border:none;cursor:pointer;transition:all .15s ease;}
button:hover{background:var(--primary-hover);}
#loginDiv,#chatDiv{flex:1;display:none;padding:16px;overflow:hidden;}
#loginDiv button{width:100%;}
#chatDiv{flex-direction:column;gap:10px;}
#messages{
  flex:1; overflow-y:auto; padding:10px; background:var(--msg-bg);
  border-radius:var(--radius); display:flex; flex-direction:column; gap:6px; min-height:0;
}
.msg{
  margin:0; padding:8px 14px; border-radius:16px; 
  word-wrap:break-word; line-height:1.3; font-size:14px;
  background:var(--other); align-self:flex-start;
  max-width: 80%;
}
.msg.me{background:var(--primary); color:#fff; align-self:flex-end;}
.msg.text-only {
  max-width: fit-content;
}
.msg.text-only.me {
  border-bottom-right-radius: 4px;
}
.msg.text-only:not(.me) {
  border-bottom-left-radius: 4px;
}
.inputRow{display:flex; gap:8px; align-items:flex-end; position:relative;}
.inputRow textarea{flex:1 1 auto; margin:0; padding-right:60px;}
.actionsRow{display:flex;justify-content:flex-end;}

/* İkon butonlar */
#imageInput,#audioInput{display:none;}
.iconBtn{
  position:absolute;
  bottom:10px;
  width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  background:#fff;
  border-radius:50%;
  border:1px solid #ddd;
  font-size:18px;
  transition: all .15s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.iconBtn:hover{
  background:#f5f5f5;
  transform: scale(1.05);
}
#imageBtn{right:50px;}
#audioBtn{right:10px;}

/* Ses kayıt aktif durumu */
.recording #audioBtn {
  background: var(--danger);
  color: white;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); }
  100% { box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); }
}

/* Çıkış ikonu */
#logoutIcon {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: var(--danger);
  color: white;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s ease;
  font-size: 20px;
  font-weight: bold;
  line-height: 1;
}

#logoutIcon:hover {
  background: var(--danger-hover);
  transform: translateY(-50%) scale(1.1);
}

.msg img{max-width:200px; border-radius:12px; margin-bottom:6px; display:block;}
.msg audio{width:180px; border-radius:12px; display:block;}

@media (max-width:600px){
  header{font-size:16px;padding:12px 45px 12px 12px;}
  .msg{font-size:13px; max-width:85%;}
  .msg img{max-width:160px;}
  .msg audio{width:150px;}
}
</style>
</head>
<body>
<div class="container">
<header>
  <div id="logoutIcon" title="Çıkış">←</div>
  İletişim Formu
</header>

<div id="loginDiv">
  <input type="email" id="email" placeholder="E-posta" />
  <input type="password" id="password" placeholder="Şifre" />
  <button onclick="login()">Giriş Yap</button>
</div>

<div id="chatDiv">
  <div id="messages" aria-live="polite"></div>
  <div class="inputRow">
    <textarea id="messageInput" placeholder="Mesaj yazın..." aria-label="Mesaj"></textarea>
    <label class="iconBtn" id="imageBtn" for="imageInput" title="Resim ekle">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 16L8 12L11 15L14 11L16 13L20 9V16C20 17.1046 19.1046 18 18 18H6C4.89543 18 4 17.1046 4 16V16Z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="8.5" cy="8.5" r="1.5" stroke="#4a69bd" stroke-width="2"/>
        <rect x="3" y="3" width="18" height="18" rx="2" stroke="#4a69bd" stroke-width="2"/>
      </svg>
    </label>
    <input type="file" id="imageInput" accept="image/*"/>
    <label class="iconBtn" id="audioBtn" title="Ses kaydet">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 3V19M8 6V16M16 8V14M20 10V12M4 10V12" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </label>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey:"AIzaSyCw44jmuiJsEXqEz71bCEPiRkc4JrAtbKM",
  authDomain:"ms4bfcw.firebaseapp.com",
  projectId:"ms4bfcw",
  storageBucket:"ms4bfcw.firebasestorage.app",
  messagingSenderId:"260708453820",
  appId:"1:260708453820:web:7857e835708603aba62fb9",
  measurementId:"G-WFMF5VGM8F"
};

const app=initializeApp(firebaseConfig);
const analytics=getAnalytics(app);
const auth=getAuth(app);
const db=getFirestore(app);

const loginDiv=document.getElementById("loginDiv");
const chatDiv=document.getElementById("chatDiv");
const messagesDiv=document.getElementById("messages");
const msgInput=document.getElementById("messageInput");
const logoutIcon = document.getElementById("logoutIcon");

let unsubscribe=null;
let lastVisible=null;
let loadingOld=false;
let isRecording = false;
let mediaRecorder;
let audioChunks=[];

if("Notification" in window) Notification.requestPermission();

onAuthStateChanged(auth,user=>{
  if(user){
    loginDiv.style.display="none";
    chatDiv.style.display="flex";
    loadMessages();
  }else{
    if(unsubscribe) unsubscribe();
    loginDiv.style.display="block";
    chatDiv.style.display="none";
    messagesDiv.innerHTML="";
    isRecording = false;
    document.body.classList.remove("recording");
  }
});

async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value;
  if(!email||!password){alert("Lütfen e-posta ve şifre girin.");return;}
  await signInWithEmailAndPassword(auth,email,password).catch(err=>alert(err.message));
}

async function logout(){
  if (isRecording && mediaRecorder && mediaRecorder.state === "recording") {
    mediaRecorder.stop();
  }
  await signOut(auth);
}

logoutIcon.addEventListener("click", logout);

document.getElementById("audioBtn").addEventListener("click", async() => {
  if (!isRecording) {
    // Kaydı başlat
    try {
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
      isRecording = true;
      document.body.classList.add("recording");
    } catch (err) {
      console.error("Mikrofon erişimi reddedildi:", err);
      alert("Ses kaydı için mikrofon erişimi gerekli!");
    }
  } else {
    // Kaydı durdur
    if (mediaRecorder && mediaRecorder.state === "recording") {
      mediaRecorder.stop();
      isRecording = false;
      document.body.classList.remove("recording");
    }
  }
});

mediaRecorder && (mediaRecorder.onstop = async() => {
  const blob = new Blob(audioChunks, {type: "audio/webm"});
  if (blob.size > 500000) {
    alert("Ses mesajı çok uzun (~10-15 sn max)"); 
    return;
  }
  const reader = new FileReader();
  reader.onloadend = async() => {
    const audioBase64 = reader.result;
    await addDoc(collection(db, "messages"), {
      sender: auth.currentUser.email,
      timestamp: serverTimestamp(),
      audioBase64
    });
  };
  reader.readAsDataURL(blob);
});

document.getElementById("imageInput").addEventListener("change", async function(){
  const file=this.files[0];
  if(!file) return;
  if(file.size>2*1024*1024){alert("Resim boyutu 2MB'den büyük olamaz"); return;}
  const reader=new FileReader();
  reader.onloadend=async()=>{
    const imageBase64=reader.result;
    await addDoc(collection(db,"messages"),{
      sender:auth.currentUser.email,
      timestamp:serverTimestamp(),
      imageBase64
    });
  };
  reader.readAsDataURL(file);
  this.value="";
});

async function sendMessage(){
  const text=msgInput.value.trim();
  if(!text || !auth.currentUser) return;
  await addDoc(collection(db,"messages"),{
    text,
    sender:auth.currentUser.email,
    timestamp:serverTimestamp()
  });
  msgInput.value="";
  msgInput.style.height = "auto";
}

msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault(); 
    sendMessage();
  }
});

msgInput.addEventListener("input", function() {
  this.style.height = "auto";
  this.style.height = (this.scrollHeight) + "px";
});

async function loadMessages(){
  const q=query(collection(db,"messages"),orderBy("timestamp","desc"),limit(20));
  const snapshot=await getDocs(q);
  lastVisible=snapshot.docs[snapshot.docs.length-1];
  let msgs=[];
  snapshot.forEach(doc=>msgs.unshift({...doc.data(),id:doc.id}));
  renderMessages(msgs);
  if(unsubscribe) unsubscribe();
  const liveQ=query(collection(db,"messages"),orderBy("timestamp","desc"),limit(1));
  unsubscribe=onSnapshot(liveQ,snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        const data=change.doc.data();
        if(data.sender!==auth.currentUser.email && Notification.permission==="granted")
          new Notification("Yeni mesaj",{body:data.text||"Yeni mesaj"});
        appendMessage(data);
      }
    });
  });
}

messagesDiv.addEventListener("scroll",async()=>{
  if(messagesDiv.scrollTop===0 && lastVisible && !loadingOld){
    loadingOld=true;
    const oldQ=query(collection(db,"messages"),orderBy("timestamp","desc"),startAfter(lastVisible),limit(20));
    const snapshot=await getDocs(oldQ);
    if(!snapshot.empty){
      lastVisible=snapshot.docs[snapshot.docs.length-1];
      let msgs=[];
      snapshot.forEach(doc=>msgs.unshift({...doc.data(),id:doc.id}));
      prependMessages(msgs);
    }
    loadingOld=false;
  }
});

function renderMessages(msgs){messagesDiv.innerHTML=""; msgs.forEach(m=>renderMessage(m)); messagesDiv.scrollTop=messagesDiv.scrollHeight;}
function appendMessage(m){renderMessage(m); messagesDiv.scrollTop=messagesDiv.scrollHeight;}
function prependMessages(msgs){const oldHeight=messagesDiv.scrollHeight; msgs.forEach(m=>{const div=createMsgDiv(m); messagesDiv.insertBefore(div,messagesDiv.firstChild);}); messagesDiv.scrollTop=messagesDiv.scrollHeight-oldHeight;}
function renderMessage(m){const div=createMsgDiv(m); messagesDiv.appendChild(div);}
function createMsgDiv(m){
  const div=document.createElement("div");
  const isMe = m.sender === auth.currentUser?.email;
  div.className="msg" + (isMe ? " me" : "");
  
  // Sadece metin mesajları için özel class
  if (!m.imageBase64 && !m.audioBase64 && m.text) {
    div.classList.add("text-only");
  }
  
  if(m.imageBase64){
    const img=document.createElement("img"); 
    img.src=m.imageBase64; 
    img.alt = "Gönderilen resim";
    div.appendChild(img);
  }
  if(m.audioBase64){
    const audio=document.createElement("audio"); 
    audio.src=m.audioBase64; 
    audio.controls=true;
    audio.setAttribute("aria-label", "Sesli mesaj");
    div.appendChild(audio);
  }
  if(m.text){
    const p=document.createElement("p"); 
    p.textContent=m.text; 
    div.appendChild(p);
  }
  return div;
}

window.login=login;
window.logout=logout;
window.sendMessage=sendMessage;
</script>
</body>
</html>