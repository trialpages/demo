<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>İletişim Formu — Şık Sohbet</title>
  <style>
    :root{
      --primary:#4a69bd;
      --primary-variant:#3b5399;
      --bg:#f5f6fa;
      --card:#ffffff;
      --msg-other:#eef1fb;
      --msg-other-2:#e6eaf6;
      --msg-me:#2f58c6;
      --muted:#8a8f9a;
      --accent:#4a69bd;
      --radius:12px;
    }
    /* Dark mode vars (toggle) */
    .dark{
      --bg:#0f1724;
      --card:#0b1220;
      --msg-other:#111827;
      --msg-other-2:#0b1220;
      --msg-me:#0b84ff;
      --muted:#94a3b8;
    }

    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Arial, Helvetica, sans-serif;background:var(--bg);color:#111}
    body{display:flex;align-items:center;justify-content:center;padding:20px}

    .container{
      width:100%;max-width:520px;height:100dvh;background:var(--card);
      display:flex;flex-direction:column;border-radius:14px;overflow:hidden;
      box-shadow:0 8px 30px rgba(18,24,40,0.08);
    }

    header{
      background:var(--primary);color:#fff;padding:14px 16px;font-size:18px;text-align:center;
      flex-shrink:0;
    }

    /* Login */
    #loginDiv{padding:18px;display:flex;flex-direction:column;gap:10px}
    input{width:100%;padding:10px;border-radius:10px;border:1px solid #dcdfe6;font-size:14px}
    button{background:var(--primary);color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer}
    button:hover{background:var(--primary-variant)}

    /* Chat area */
    #chatDiv{flex:1;display:flex;flex-direction:column;padding:16px;gap:12px;min-height:0}
    #messages{
      flex:1;overflow-y:auto;padding:12px;border-radius:12px;background:linear-gradient(180deg,transparent,transparent);
      display:flex;flex-direction:column;gap:10px;min-height:0;
    }

    /* Date / group label above groups */
    .groupTime{
      font-size:11px;color:var(--muted);text-align:center;opacity:0.9;
      margin:6px 0;
    }

    .msgWrap{
      display:flex;flex-direction:column;gap:6px;max-width:100%;
    }

    .msg{
      display:inline-block;padding:8px 12px;border-radius:16px;max-width:78%;
      word-wrap:break-word;line-height:1.3;font-size:14px;position:relative;
      box-shadow:0 6px 18px rgba(10,12,20,0.04);
    }
    .msg.me{
      background:var(--msg-me);color:#fff;align-self:flex-end;border-bottom-right-radius:6px;
      box-shadow:0 8px 22px rgba(42,60,120,0.12);
    }
    .msg.other{
      background:var(--msg-other);color:#111;align-self:flex-start;border-bottom-left-radius:6px;
      box-shadow:0 6px 18px rgba(14,20,40,0.04);
    }
    /* Slight tonal difference for alternating other messages */
    .msg.other.alt{ background:var(--msg-other-2); }

    /* Small time inside bubble bottom-right */
    .msgTime{
      font-size:11px;color:rgba(255,255,255,0.8);position:absolute;right:8px;bottom:4px;opacity:0.9;
    }
    .msg.other .msgTime{ color:var(--muted);opacity:0.85; }

    /* Input row */
    .inputRow{display:flex;gap:12px;align-items:flex-end}
    .inputBox{flex:1;display:flex;align-items:flex-start;gap:10px}
    textarea#messageInput{
      width:100%;min-height:56px;max-height:140px;padding:12px;border-radius:12px;border:1px solid #e4e7ef;
      resize:none;outline:none;font-family:"Times New Roman", Times, serif;font-size:15px;
      background:linear-gradient(180deg, #fff, #fbfdff);
      box-shadow:inset 0 1px 0 rgba(255,255,255,0.6);
    }

    /* Icon column to the right of textarea */
    .iconCol{
      display:flex;flex-direction:column;gap:8px;align-items:center;justify-content:flex-end;
      width:54px;padding-bottom:6px;
    }
    .iconBtn{
      width:44px;height:44px;border-radius:10px;border:none;display:inline-flex;align-items:center;
      justify-content:center;background:transparent;cursor:pointer;outline:none;
      transition:transform .12s ease, background .12s ease;
      border:1px solid transparent;
    }
    .iconBtn:hover{ transform:translateY(-2px); border-color: rgba(0,0,0,0.06); background: rgba(0,0,0,0.03); }
    .iconBtn svg{ width:20px;height:20px; display:block; stroke:currentColor; fill:none; color:var(--muted) }

    /* radio playing state */
    .playing{ background: linear-gradient(135deg,var(--primary),var(--primary-variant)); color:#fff; border-color:transparent }
    .playing svg{ stroke:#fff; }

    .actionsRow{display:flex;justify-content:flex-end}

    /* logout small button */
    #logoutBtn{background:transparent;border:1px solid #f2dede;color:var(--danger);padding:6px 10px;border-radius:999px}

    @media (max-width:600px){
      .container{max-width:100%;}
      .iconCol{width:44px}
      .iconBtn{width:40px;height:40px}
      .msg{font-size:13px}
      header{font-size:16px}
    }
  </style>
</head>
<body>
  <div class="container" id="rootContainer">
    <header>İletişim Formu</header>

    <!-- Giriş -->
    <div id="loginDiv">
      <input type="email" id="email" placeholder="E-posta" />
      <input type="password" id="password" placeholder="Şifre" />
      <button onclick="login()">Giriş Yap</button>
    </div>

    <!-- Sohbet -->
    <div id="chatDiv" style="display:none;">
      <div id="messages" aria-live="polite"></div>

      <div class="inputRow" aria-hidden="false">
        <div class="inputBox">
          <textarea id="messageInput" placeholder="Mesaj yazın..." aria-label="Mesaj"></textarea>
        </div>

        <!-- Sağdaki ikon sütunu -->
        <div class="iconCol" role="toolbar" aria-label="Araçlar">
          <!-- Radyo -->
          <button class="iconBtn" id="radioBtn" title="Radyo (çalıştır/durdur)" aria-pressed="false" aria-label="Radyo">
            <svg viewBox="0 0 24 24" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M4 10h16v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8z"></path>
              <rect x="2" y="4" width="20" height="6" rx="2"></rect>
              <circle cx="8.5" cy="13.5" r="1.4" fill="currentColor"></circle>
              <path d="M16 6l2 2m0-2-2 2"></path>
            </svg>
          </button>

          <!-- Dark mode -->
          <button class="iconBtn" id="darkBtn" title="Koyu modu aç/kapat" aria-pressed="false" aria-label="Koyu Mod">
            <svg viewBox="0 0 24 24" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
            </svg>
          </button>

          <!-- Logout -->
          <button class="iconBtn" id="logoutIconBtn" title="Çıkış" aria-label="Çıkış">
            <svg viewBox="0 0 24 24" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <path d="M16 17l5-5-5-5"></path>
              <path d="M21 12H9"></path>
            </svg>
          </button>
        </div>
      </div>

      <div class="actionsRow" style="display:none;">
        <button id="logoutBtn" onclick="logout()">Çıkış</button>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase config (senin verdiğin) ----------
    const firebaseConfig = {
      apiKey: "AIzaSyA2EtFfhxcVp_gOk0sany4frsI__OMKnsA",
      authDomain: "ifreli-muhabbet.firebaseapp.com",
      projectId: "ifreli-muhabbet",
      storageBucket: "ifreli-muhabbet.firebasestorage.app",
      messagingSenderId: "83940267241",
      appId: "1:83940267241:web:b3d39fc721b75e9377cc78"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Elements
    const loginDiv = document.getElementById("loginDiv");
    const chatDiv = document.getElementById("chatDiv");
    const messagesDiv = document.getElementById("messages");
    const msgInput = document.getElementById("messageInput");
    const radioBtn = document.getElementById("radioBtn");
    const darkBtn = document.getElementById("darkBtn");
    const logoutIconBtn = document.getElementById("logoutIconBtn");
    const rootContainer = document.getElementById("rootContainer");

    // State
    let unsubscribe = null;
    let lastVisible = null;
    let loadingOld = false;
    let audio = null;
    let radioPlaying = false;
    let prevSender = null; // for grouping when rendering

    // bildirim izni (isteğe bağlı)
    if ("Notification" in window) Notification.requestPermission().catch(()=>{});

    // Auth listener
    onAuthStateChanged(auth, user => {
      if (user) {
        loginDiv.style.display = "none";
        chatDiv.style.display = "flex";
        messagesDiv.innerHTML = "";
        loadMessages();
      } else {
        if (unsubscribe) unsubscribe();
        loginDiv.style.display = "block";
        chatDiv.style.display = "none";
        messagesDiv.innerHTML = "";
      }
    });

    // Login
    async function login(){
      const email = document.getElementById("email").value.trim();
      const password = document.getElementById("password").value;
      if(!email || !password){ alert("Lütfen e-posta ve şifre girin."); return; }
      try{
        await signInWithEmailAndPassword(auth,email,password);
      }catch(err){
        alert(err.message || "Giriş yapılamadı.");
      }
    }

    // Logout
    async function logout(){
      try{
        if(audio && radioPlaying){ audio.pause(); radioPlaying=false; radioBtn.classList.remove('playing'); }
        await signOut(auth);
      }catch(err){ console.error(err); alert("Çıkış yapılamadı."); }
    }

    // Send message
    async function sendMessage(){
      const text = msgInput.value.trim();
      if(!text) return;
      if(!auth.currentUser) return;
      try{
        await addDoc(collection(db,"messages"),{
          text,
          sender: auth.currentUser.email,
          timestamp: serverTimestamp()
        });
        msgInput.value = "";
        // Optionally scroll - will be handled by onSnapshot append
      }catch(err){
        console.error(err);
      }
    }

    // Enter ile gönder (Shift+Enter yeni satır)
    msgInput.addEventListener("keydown", e=>{
      if(e.key === "Enter" && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });

    // Load initial messages (most recent 20) and attach live listener for new ones
    async function loadMessages(){
      // get latest 20 (desc)
      const q = query(collection(db,"messages"), orderBy("timestamp","desc"), limit(20));
      const snapshot = await getDocs(q);
      lastVisible = snapshot.docs[snapshot.docs.length - 1] || null;
      let msgs = [];
      snapshot.forEach(doc => {
        const d = doc.data();
        msgs.unshift({ id: doc.id, text: d.text, sender: d.sender, timestamp: d.timestamp ? d.timestamp.toDate() : new Date() });
      });
      renderMessages(msgs);

      // live listener for newest message(s)
      if (unsubscribe) unsubscribe();
      const liveQ = query(collection(db,"messages"), orderBy("timestamp","desc"), limit(5));
      unsubscribe = onSnapshot(liveQ, snap=>{
        snap.docChanges().forEach(change=>{
          if(change.type === "added"){
            const d = change.doc.data();
            const m = { id: change.doc.id, text: d.text, sender: d.sender, timestamp: d.timestamp ? d.timestamp.toDate() : new Date() };
            // if message is from someone else, show notification
            if (auth.currentUser && m.sender !== auth.currentUser.email && Notification.permission === "granted"){
              try { new Notification("Yeni mesaj", { body: m.text.slice(0,120) }); } catch(e){}
            }
            appendMessage(m);
          }
        });
      });
    }

    // Infinite scroll (load older)
    messagesDiv.addEventListener("scroll", async ()=>{
      // when user scrolls to top, load older (the query uses desc + startAfter(prev) pattern)
      if(messagesDiv.scrollTop <= 10 && lastVisible && !loadingOld){
        loadingOld = true;
        const oldQ = query(collection(db,"messages"), orderBy("timestamp","desc"), startAfter(lastVisible), limit(20));
        const snapshot = await getDocs(oldQ);
        if (!snapshot.empty){
          lastVisible = snapshot.docs[snapshot.docs.length - 1];
          const older = [];
          snapshot.forEach(doc=>{
            const d = doc.data();
            older.unshift({ id: doc.id, text: d.text, sender: d.sender, timestamp: d.timestamp ? d.timestamp.toDate() : new Date() });
          });
          prependMessages(older);
        }
        loadingOld = false;
      }
    });

    // Rendering helpers: group messages by sender so groupTime appears above groups
    function renderMessages(msgs){
      messagesDiv.innerHTML = "";
      prevSender = null;
      msgs.forEach(m => renderMessage(m));
      // scroll to bottom
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function appendMessage(m){
      // if we already have message with same id at end, skip (avoid duplicates)
      const lastChild = messagesDiv.lastElementChild;
      if(lastChild && lastChild.dataset && lastChild.dataset.id === m.id) return;
      renderMessage(m);
      // scroll to bottom smoothly
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    function prependMessages(msgs){
      // preserve scroll position
      const oldScroll = messagesDiv.scrollHeight;
      const oldTop = messagesDiv.scrollTop;
      msgs.forEach(m => {
        // insert at top
        const node = createMsgNode(m);
        messagesDiv.insertBefore(node, messagesDiv.firstChild);
      });
      // adjust scroll so view stays approx same
      const newScroll = messagesDiv.scrollHeight;
      messagesDiv.scrollTop = newScroll - oldScroll + oldTop;
    }

    function renderMessage(m){
      const node = createMsgNode(m);
      messagesDiv.appendChild(node);
    }

    function createMsgNode(m){
      const wrap = document.createElement("div");
      wrap.className = "msgWrap";
      wrap.dataset.id = m.id || "";

      // determine grouping: if sender changed compared to previous rendered message, show small time label above
      const sender = m.sender || "unknown";
      const timeStr = formatTime(m.timestamp || new Date());

      if(prevSender === null || prevSender !== sender){
        const g = document.createElement("div");
        g.className = "groupTime";
        g.textContent = timeStr; // küçük grup zaman etiketi
        wrap.appendChild(g);
      }

      const bubble = document.createElement("div");
      const isMe = auth.currentUser && sender === auth.currentUser.email;
      bubble.className = "msg " + (isMe ? "me" : "other");
      // alternate tone for other people's messages to add subtle variety (based on hash of sender + id)
      if(!isMe){
        const alt = hashToAlternation(sender + (m.id||"")) % 2 === 0;
        if(alt) bubble.classList.add("alt");
      }

      // message text
      bubble.textContent = m.text || "";

      // small time inside bubble (HH:MM) bottom-right
      const tspan = document.createElement("span");
      tspan.className = "msgTime";
      tspan.textContent = timeStr;
      bubble.appendChild(tspan);

      wrap.appendChild(bubble);

      // update prevSender for next message
      prevSender = sender;
      return wrap;
    }

    function formatTime(d){
      try{
        const date = (d instanceof Date) ? d : new Date(d);
        const hh = String(date.getHours()).padStart(2,"0");
        const mm = String(date.getMinutes()).padStart(2,"0");
        return hh + ":" + mm;
      }catch(e){
        return "";
      }
    }

    // simple hash -> alternation for styling
    function hashToAlternation(s){
      let h=0;
      for(let i=0;i<s.length;i++) h = ((h<<5)-h)+s.charCodeAt(i), h |= 0;
      return Math.abs(h);
    }

    // ---------------- UI interactions ----------------

    // Radio play/stop
    radioBtn.addEventListener("click", ()=>{
      if(!audio){
        audio = new Audio("http://stream.radyo45lik.com:4545/stream");
        audio.crossOrigin = "anonymous";
        audio.preload = "none";
      }
      if(!radioPlaying){
        audio.play().then(()=>{
          radioPlaying = true;
          radioBtn.classList.add("playing");
          radioBtn.setAttribute("aria-pressed","true");
        }).catch(err=>{
          console.warn("Radyo başlatılamadı:", err);
          alert("Tarayıcı otomatik oynatmayı engelliyor olabilir. İzni onaylayıp tekrar deneyin.");
        });
      }else{
        audio.pause();
        radioPlaying = false;
        radioBtn.classList.remove("playing");
        radioBtn.setAttribute("aria-pressed","false");
      }
    });

    // Dark mode toggle
    darkBtn.addEventListener("click", ()=>{
      const body = document.documentElement;
      const pressed = body.classList.toggle("dark");
      darkBtn.setAttribute("aria-pressed", String(pressed));
      // küçük görsel geri bildirim
      darkBtn.animate([{transform:"scale(0.92)"},{transform:"scale(1)"}],{duration:150});
    });

    // logout icon
    logoutIconBtn.addEventListener("click", ()=>{
      logout();
    });

    // Ensure when page loads, pressing Ctrl+K etc doesn't create weird focus behaviour
    window.addEventListener("keydown", (e)=>{
      // Ctrl+K to focus message input (convenience)
      if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==='k'){
        e.preventDefault(); msgInput.focus();
      }
    });

    // expose functions for HTML hooks
    window.login = login;
    window.logout = logout;
    window.sendMessage = sendMessage;

    // Accessibility: keep message input focused on load if logged in
    // (when auth state changes, focus set)
    onAuthStateChanged(auth, user=>{
      if(user){
        setTimeout(()=> msgInput.focus(),200);
      }
    });
  </script>
</body>
</html>
