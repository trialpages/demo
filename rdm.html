<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>İletişim Formu</title>
<style>
:root {
  --primary: #4a69bd;
  --primary-hover: #3b5399;
  --bg: #f5f6fa;
  --msg-bg: #f1f2f6;
  --other: #dfe4ea;
  --danger: #e74c3c;
  --danger-hover: #c0392b;
  --radius: 12px;
  
  /* Dark mode variables */
  --dark-bg: #1a1a2e;
  --dark-container: #16213e;
  --dark-header: #0f3460;
  --dark-text: #e6e6e6;
  --dark-msg-bg: #2a2a4a;
  --dark-input-bg: #2a2a4a;
  --dark-input-text: #f0f0f0;
  --dark-icon-bg: #2a2a4a;
  --dark-other: #3d3d5c;
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;background:var(--bg);}
body{display:flex;align-items:center;justify-content:center;transition: background-color 0.3s ease;}
body.dark-mode {background: var(--dark-bg);}

.container{
  width:100%; max-width:480px; height:100dvh;
  background:#fff; display:flex; flex-direction:column;
  box-shadow:0 4px 20px rgba(0,0,0,0.12);
  position:relative;
  transition: background-color 0.3s ease;
}
.dark-mode .container {
  background: var(--dark-container);
  box-shadow: 0 4px 20px rgba(0,0,0,0.25);
}

header{
  background:var(--primary); color:#fff;
  padding:14px 16px; text-align:center; font-size:18px; font-weight:500;
  flex-shrink:0; position:relative;
}
.dark-mode header {
  background: var(--dark-header);
}

input,textarea,button{border-radius:var(--radius);border:1px solid #ccc;font-size:14px;}
input,textarea{width:100%; padding:10px; margin:8px 0; background:#fff;}
textarea{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;resize:none;min-height:42px; max-height:140px; padding-right: 110px;}
.dark-mode input, 
.dark-mode textarea {
  background: var(--dark-input-bg);
  color: var(--dark-input-text);
  border-color: #444;
}

button{background:var(--primary);color:#fff;padding:10px;border:none;cursor:pointer;transition:all .15s ease;}
button:hover{background:var(--primary-hover);}
.dark-mode button:hover {
  opacity: 0.9;
}

#loginDiv,#chatDiv{flex:1;display:none;padding:16px;overflow:hidden;}
#loginDiv button{width:100%;}
#chatDiv{flex-direction:column;gap:10px;}

#messages{
  flex:1; overflow-y:auto; padding:10px; background:var(--msg-bg);
  border-radius:var(--radius); display:flex; flex-direction:column; gap:6px; min-height:0;
}
.dark-mode #messages {
  background: var(--dark-msg-bg);
}

.msg{
  margin:0; padding:8px 14px; border-radius:12px; 
  word-wrap:break-word; line-height:1.3; font-size:14px;
  background:var(--other); align-self:flex-start;
  max-width: 70%;
  position: relative;
}
.dark-mode .msg {
  background: var(--dark-other);
  color: var(--dark-text);
}

.msg.me{background:var(--primary); color:#fff; align-self:flex-end;}
.dark-mode .msg.me {
  background: var(--primary);
}

.msg.text-only {
  max-width: fit-content;
}

.msg.text-only.me {
  border-bottom-right-radius: 4px;
}

.msg.text-only:not(.me) {
  border-bottom-left-radius: 4px;
}

.inputRow{display:flex; gap:8px; align-items:flex-end; position:relative;}
.inputRow textarea{flex:1 1 auto; margin:0;}
.actionsRow{display:flex;justify-content:flex-end;}

/* İkon butonlar */
#imageInput{display:none;}
.iconBtn{
  position:absolute;
  bottom:10px;
  width:32px; height:32px;
  display:flex; align-items:center; justify-content:center;
  cursor:pointer;
  background:#fff;
  border-radius:50%;
  border:1px solid #ddd;
  font-size:18px;
  transition: all .15s ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.dark-mode .iconBtn {
  background: var(--dark-icon-bg);
  border-color: #444;
  color: #f0f0f0;
}

.iconBtn:hover{
  background:#f5f5f5;
  transform: scale(1.05);
}
.dark-mode .iconBtn:hover {
  background: #3d3d5c;
}

#imageBtn{right:70px;}
#darkModeBtn{right:40px;}
#logoutBtn{right:10px;}

/* Mesaj zaman damgası */
.timestamp {
  font-size: 10px;
  opacity: 0.7;
  margin-top: 4px;
  display: block;
  text-align: right;
}
.msg:not(.me) .timestamp {
  text-align: left;
}
.dark-mode .timestamp {
  color: rgba(255, 255, 255, 0.6);
}

.msg img{max-width:200px; border-radius:8px; margin-bottom:6px; display:block;}
.msg audio{width:180px; border-radius:8px; display:block;}

@media (max-width:600px){
  header{font-size:16px;padding:12px 12px;}
  .msg{font-size:13px; max-width:75%;}
  .msg img{max-width:160px;}
  .msg audio{width:150px;}
}
</style>
</head>
<body>
<div class="container">
<header>
  İletişim Formu
</header>

<div id="loginDiv">
  <input type="email" id="email" placeholder="E-posta" />
  <input type="password" id="password" placeholder="Şifre" />
  <button onclick="login()">Giriş Yap</button>
</div>

<div id="chatDiv">
  <div id="messages" aria-live="polite"></div>
  <div class="inputRow">
    <textarea id="messageInput" placeholder="Mesaj yazın..." aria-label="Mesaj"></textarea>
    
    <label class="iconBtn" id="imageBtn" for="imageInput" title="Resim ekle">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M4 16L8 12L11 15L14 11L16 13L20 9V16C20 17.1046 19.1046 18 18 18H6C4.89543 18 4 17.1046 4 16V16Z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <circle cx="8.5" cy="8.5" r="1.5" stroke="#4a69bd" stroke-width="2"/>
        <rect x="3" y="3" width="18" height="18" rx="2" stroke="#4a69bd" stroke-width="2"/>
      </svg>
    </label>
    
    <button class="iconBtn" id="darkModeBtn" title="Karanlık mod">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 2V4" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 20V22" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M4.93 4.93L6.34 6.34" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M17.66 17.66L19.07 19.07" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12H4" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 12H22" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6.34 17.66L4.93 19.07" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M19.07 4.93L17.66 6.34" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <button class="iconBtn" id="logoutBtn" title="Çıkış">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M9 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V5C3 4.46957 3.21071 3.96086 3.58579 3.58579C3.96086 3.21071 4.46957 3 5 3H9" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M16 17L21 12L16 7" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M21 12H9" stroke="#e74c3c" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    </button>
    
    <input type="file" id="imageInput" accept="image/*"/>
  </div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
import { getFirestore, collection, addDoc, query, orderBy, limit, startAfter, getDocs, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-analytics.js";

const firebaseConfig = {
  apiKey:"AIzaSyCw44jmuiJsEXqEz71bCEPiRkc4JrAtbKM",
  authDomain:"ms4bfcw.firebaseapp.com",
  projectId:"ms4bfcw",
  storageBucket:"ms4bfcw.firebasestorage.app",
  messagingSenderId:"260708453820",
  appId:"1:260708453820:web:7857e835708603aba62fb9",
  measurementId:"G-WFMF5VGM8F"
};

const app=initializeApp(firebaseConfig);
const analytics=getAnalytics(app);
const auth=getAuth(app);
const db=getFirestore(app);

const loginDiv=document.getElementById("loginDiv");
const chatDiv=document.getElementById("chatDiv");
const messagesDiv=document.getElementById("messages");
const msgInput=document.getElementById("messageInput");
const darkModeBtn = document.getElementById("darkModeBtn");
const logoutBtn = document.getElementById("logoutBtn");

let unsubscribe=null;
let lastVisible=null;
let loadingOld=false;

// Dark mode kontrolü
function initDarkMode() {
  const isDarkMode = localStorage.getItem('darkMode') === 'true';
  if (isDarkMode) {
    document.body.classList.add('dark-mode');
    darkModeBtn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    darkModeBtn.title = "Açık mod";
  }
}

// Dark mode toggle fonksiyonu
function toggleDarkMode() {
  const isDarkMode = document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', isDarkMode);
  
  if (isDarkMode) {
    darkModeBtn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    darkModeBtn.title = "Açık mod";
  } else {
    darkModeBtn.innerHTML = `
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16Z" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 2V4" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 20V22" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M4.93 4.93L6.34 6.34" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M17.66 17.66L19.07 19.07" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M2 12H4" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M20 12H22" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M6.34 17.66L4.93 19.07" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M19.07 4.93L17.66 6.34" stroke="#4a69bd" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
    `;
    darkModeBtn.title = "Karanlık mod";
  }
}

initDarkMode();

if("Notification" in window) Notification.requestPermission();

onAuthStateChanged(auth,user=>{
  if(user){
    loginDiv.style.display="none";
    chatDiv.style.display="flex";
    loadMessages();
  }else{
    if(unsubscribe) unsubscribe();
    loginDiv.style.display="block";
    chatDiv.style.display="none";
    messagesDiv.innerHTML="";
  }
});

async function login(){
  const email=document.getElementById("email").value.trim();
  const password=document.getElementById("password").value;
  if(!email||!password){alert("Lütfen e-posta ve şifre girin.");return;}
  await signInWithEmailAndPassword(auth,email,password).catch(err=>alert(err.message));
}

async function logout(){
  await signOut(auth);
}

// Buton event listener'ları
darkModeBtn.addEventListener("click", toggleDarkMode);
logoutBtn.addEventListener("click", logout);

document.getElementById("imageInput").addEventListener("change", async function(){
  const file=this.files[0];
  if(!file) return;
  if(file.size>2*1024*1024){alert("Resim boyutu 2MB'den büyük olamaz"); return;}
  const reader=new FileReader();
  reader.onloadend=async()=>{
    const imageBase64=reader.result;
    await addDoc(collection(db,"messages"),{
      sender:auth.currentUser.email,
      timestamp:serverTimestamp(),
      imageBase64
    });
  };
  reader.readAsDataURL(file);
  this.value="";
});

async function sendMessage(){
  const text=msgInput.value.trim();
  if(!text || !auth.currentUser) return;
  await addDoc(collection(db,"messages"),{
    text,
    sender:auth.currentUser.email,
    timestamp:serverTimestamp()
  });
  msgInput.value="";
  msgInput.style.height = "auto";
}

msgInput.addEventListener("keydown",e=>{
  if(e.key==="Enter"&&!e.shiftKey){
    e.preventDefault(); 
    sendMessage();
  }
});

msgInput.addEventListener("input", function() {
  this.style.height = "auto";
  this.style.height = (this.scrollHeight) + "px";
});

async function loadMessages(){
  const q=query(collection(db,"messages"),orderBy("timestamp","desc"),limit(20));
  const snapshot=await getDocs(q);
  lastVisible=snapshot.docs[snapshot.docs.length-1];
  let msgs=[];
  snapshot.forEach(doc=>msgs.unshift({...doc.data(),id:doc.id}));
  renderMessages(msgs);
  if(unsubscribe) unsubscribe();
  const liveQ=query(collection(db,"messages"),orderBy("timestamp","desc"),limit(1));
  unsubscribe=onSnapshot(liveQ,snap=>{
    snap.docChanges().forEach(change=>{
      if(change.type==="added"){
        const data=change.doc.data();
        if(data.sender!==auth.currentUser.email && Notification.permission==="granted")
          new Notification("Yeni mesaj",{body:data.text||"Yeni mesaj"});
        appendMessage(data);
      }
    });
  });
}

messagesDiv.addEventListener("scroll",async()=>{
  if(messagesDiv.scrollTop===0 && lastVisible && !loadingOld){
    loadingOld=true;
    const oldQ=query(collection(db,"messages"),orderBy("timestamp","desc"),startAfter(lastVisible),limit(20));
    const snapshot=await getDocs(oldQ);
    if(!snapshot.empty){
      lastVisible=snapshot.docs[snapshot.docs.length-1];
      let msgs=[];
      snapshot.forEach(doc=>msgs.unshift({...doc.data(),id:doc.id}));
      prependMessages(msgs);
    }
    loadingOld=false;
  }
});

function formatTime(date) {
  if (!date) return '';
  
  // Firestore Timestamp nesnesini Date nesnesine çevir
  const jsDate = date.toDate ? date.toDate() : new Date(date);
  
  const hours = String(jsDate.getHours()).padStart(2, '0');
  const minutes = String(jsDate.getMinutes()).padStart(2, '0');
  const seconds = String(jsDate.getSeconds()).padStart(2, '0');
  
  return `${hours}:${minutes}:${seconds}`;
}

function renderMessages(msgs){messagesDiv.innerHTML=""; msgs.forEach(m=>renderMessage(m)); messagesDiv.scrollTop=messagesDiv.scrollHeight;}
function appendMessage(m){renderMessage(m); messagesDiv.scrollTop=messagesDiv.scrollHeight;}
function prependMessages(msgs){const oldHeight=messagesDiv.scrollHeight; msgs.forEach(m=>{const div=createMsgDiv(m); messagesDiv.insertBefore(div,messagesDiv.firstChild);}); messagesDiv.scrollTop=messagesDiv.scrollHeight-oldHeight;}
function renderMessage(m){const div=createMsgDiv(m); messagesDiv.appendChild(div);}
function createMsgDiv(m){
  const div=document.createElement("div");
  const isMe = m.sender === auth.currentUser?.email;
  div.className="msg" + (isMe ? " me" : "");
  
  // Sadece metin mesajları için özel class
  if (!m.imageBase64 && !m.audioBase64 && m.text) {
    div.classList.add("text-only");
  }
  
  if(m.imageBase64){
    const img=document.createElement("img"); 
    img.src=m.imageBase64; 
    img.alt = "Gönderilen resim";
    div.appendChild(img);
  }
  
  if(m.text){
    const p=document.createElement("p"); 
    p.textContent=m.text; 
    div.appendChild(p);
  }
  
  // Zaman damgası ekle
  const timeSpan = document.createElement("span");
  timeSpan.className = "timestamp";
  timeSpan.textContent = formatTime(m.timestamp);
  div.appendChild(timeSpan);
  
  return div;
}

window.login=login;
window.logout=logout;
window.sendMessage=sendMessage;
</script>
</body>
</html>
