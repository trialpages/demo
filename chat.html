<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Modern Chat</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00a884;
            --bg-color: #efeae2;
            --msg-sent: #d9fdd3;
            --msg-received: #ffffff;
            --text-primary: #111b21;
            --text-secondary: #667781;
        }

        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #d1d7db; height: 100vh; display: flex; justify-content: center; align-items: center; }
        
        /* Ana Konteyner (Mobil Görünüm) */
        .app-container {
            width: 100%; height: 100%; max-width: 450px; background: var(--bg-color); display: flex; flex-direction: column; position: relative; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        /* Header */
        header {
            background-color: #f0f2f5; padding: 10px 16px; display: flex; align-items: center; border-bottom: 1px solid #e9edef; z-index: 10;
        }
        .avatar { width: 40px; height: 40px; background: #dfe5e7; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; margin-right: 15px; }
        .user-info { flex: 1; }
        .user-name { font-weight: 600; font-size: 16px; color: var(--text-primary); }
        .user-status { font-size: 12px; color: var(--text-secondary); height: 16px; }
        .status-dot { width: 8px; height: 8px; background-color: #25d366; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        /* Mesaj Alanı */
        #chat-area {
            flex: 1; overflow-y: auto; padding: 20px; background-image: url('https://user-images.githubusercontent.com/15075759/28719144-86dc0f70-73b1-11e7-911d-60d70fcded21.png'); background-blend-mode: overlay; background-color: #efeae2; display: flex; flex-direction: column; gap: 8px;
        }

        .message { max-width: 80%; padding: 8px 12px; border-radius: 8px; position: relative; font-size: 14.2px; line-height: 19px; box-shadow: 0 1px 0.5px rgba(0,0,0,0.13); word-wrap: break-word; }
        .sent { align-self: flex-end; background-color: var(--msg-sent); border-top-right-radius: 0; }
        .received { align-self: flex-start; background-color: var(--msg-received); border-top-left-radius: 0; }
        
        .msg-time { font-size: 11px; color: var(--text-secondary); text-align: right; margin-top: 4px; margin-left: 10px; float: right; }
        
        .msg-image { max-width: 100%; border-radius: 6px; cursor: pointer; margin-bottom: 5px; }
        .audio-player { width: 200px; margin-top: 5px; }

        /* Footer / Input */
        .input-area {
            background-color: #f0f2f5; padding: 8px 10px; display: flex; align-items: center; gap: 10px; min-height: 60px;
        }
        .icon-btn { color: #54656f; cursor: pointer; font-size: 20px; padding: 8px; transition: color 0.2s; background: none; border: none; }
        .icon-btn:hover { color: var(--text-primary); }
        .input-box {
            flex: 1; background: white; border-radius: 8px; padding: 9px 12px; border: 1px solid white; outline: none; font-size: 15px; max-height: 100px; overflow-y: auto;
        }
        .input-box:focus { border-color: white; }
        
        /* Kayıt Animasyonu */
        .recording-ui { display: none; flex: 1; align-items: center; color: #ff3b30; font-weight: bold; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Hidden Input */
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="app-container">
    <header>
        <div class="avatar"><i class="fas fa-user"></i></div>
        <div class="user-info">
            <div class="user-name">Sohbet Odası</div>
            <div class="user-status" id="header-status">
                </div>
        </div>
    </header>

    <div id="chat-area">
        </div>

    <div class="input-area">
        <button class="icon-btn" onclick="document.getElementById('file-input').click()">
            <i class="fas fa-plus"></i>
        </button>
        <input type="file" id="file-input" accept="image/*" onchange="uploadImage(this)">

        <input type="text" class="input-box" id="msg-input" placeholder="Bir mesaj yazın" autocomplete="off">
        
        <div class="recording-ui" id="recording-ui">
            <i class="fas fa-microphone" style="margin-right: 10px;"></i> Kaydediliyor... <span id="rec-timer">00:00</span>
        </div>

        <button class="icon-btn" id="action-btn">
            <i class="fas fa-microphone" id="mic-icon"></i>
            <i class="fas fa-paper-plane" id="send-icon" style="display: none; color: var(--primary-color);"></i>
        </button>
    </div>
</div>

<script type="module">
    // --- FIREBASE KURULUMU ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, push, onChildAdded, onValue, set, onDisconnect, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js";

    // BURAYI KENDİ BİLGİLERİNLE DOLDUR
    const firebaseConfig = {
        apiKey: "SENIN_API_KEY",
        authDomain: "SENIN_PROJE.firebaseapp.com",
        databaseURL: "https://SENIN_PROJE-default-rtdb.firebaseio.com",
        projectId: "SENIN_PROJE_ID",
        storageBucket: "SENIN_PROJE.appspot.com",
        messagingSenderId: "...",
        appId: "..."
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const storage = getStorage(app);

    let currentUser = null;
    let myStatusRef = null;
    
    // --- AUTH & PRESENCE (ONLİNE DURUMU) ---
    signInAnonymously(auth);
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            // Online durumunu ayarla
            const connectedRef = ref(db, ".info/connected");
            myStatusRef = ref(db, 'status/' + user.uid);
            
            onValue(connectedRef, (snap) => {
                if (snap.val() === true) {
                    set(myStatusRef, { state: 'online', last_changed: serverTimestamp() });
                    onDisconnect(myStatusRef).set({ state: 'offline', last_changed: serverTimestamp() });
                }
            });
        }
    });

    // Başkasının durumunu izle (Basitçe son aktif kişiyi veya genel durumu izler)
    const statusHeader = document.getElementById('header-status');
    const allStatusRef = ref(db, 'status/');
    onValue(allStatusRef, (snapshot) => {
        let anyoneOnline = false;
        snapshot.forEach((child) => {
            if (currentUser && child.key !== currentUser.uid && child.val().state === 'online') {
                anyoneOnline = true;
            }
        });
        
        // Önce yazıyor mu diye bak, değilse online durumu
        checkTypingStatus(anyoneOnline);
    });

    // --- YAZIYOR... (TYPING INDICATOR) ---
    const msgInput = document.getElementById('msg-input');
    const typingRef = ref(db, 'typing/');
    let typingTimeout;

    msgInput.addEventListener('input', () => {
        if (!currentUser) return;
        set(ref(db, `typing/${currentUser.uid}`), true);
        
        clearTimeout(typingTimeout);
        typingTimeout = setTimeout(() => {
            set(ref(db, `typing/${currentUser.uid}`), null);
        }, 2000); // 2 saniye yazmazsa sil
        
        toggleSendButton(msgInput.value.length > 0);
    });

    function checkTypingStatus(isOnline) {
        onValue(typingRef, (snap) => {
            let isTyping = false;
            snap.forEach((child) => {
                if (currentUser && child.key !== currentUser.uid && child.val() === true) {
                    isTyping = true;
                }
            });

            if (isTyping) {
                statusHeader.innerText = "yazıyor...";
                statusHeader.style.color = "#00a884";
                statusHeader.style.fontWeight = "bold";
            } else {
                statusHeader.style.color = "#667781";
                statusHeader.style.fontWeight = "normal";
                statusHeader.innerHTML = isOnline ? '<span class="status-dot"></span>Çevrimiçi' : '';
            }
        });
    }

    // --- MESAJ GÖNDERME & ALMA ---
    const messagesRef = ref(db, 'messages/');
    const chatArea = document.getElementById('chat-area');
    const actionBtn = document.getElementById('action-btn');
    const micIcon = document.getElementById('mic-icon');
    const sendIcon = document.getElementById('send-icon');

    // Buton İkon Değişimi (Mikrofon <-> Gönder)
    function toggleSendButton(hasText) {
        if (hasText) {
            micIcon.style.display = 'none';
            sendIcon.style.display = 'block';
            actionBtn.onclick = sendMessage;
        } else {
            micIcon.style.display = 'block';
            sendIcon.style.display = 'none';
            // Eğer kayıt yoksa kaydı başlat, varsa durdur mantığı aşağıda
            actionBtn.onmousedown = startRecording;
            actionBtn.onmouseup = stopRecording;
            // Mobil için touch events
            actionBtn.ontouchstart = startRecording;
            actionBtn.ontouchend = stopRecording;
        }
    }

    // Mesaj Gönder
    window.sendMessage = function() {
        const text = msgInput.value.trim();
        if (text === "") return;

        push(messagesRef, {
            sender: currentUser.uid,
            text: text,
            type: 'text',
            timestamp: serverTimestamp()
        });

        msgInput.value = "";
        toggleSendButton(false);
        set(ref(db, `typing/${currentUser.uid}`), null); // Yazıyoru kaldır
    }

    // Enter tuşu ile gönder
    msgInput.addEventListener("keypress", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            sendMessage();
        }
    });

    // Mesajları Ekrana Bas
    onChildAdded(messagesRef, (snapshot) => {
        const msg = snapshot.val();
        const isMe = msg.sender === currentUser.uid;
        const msgDiv = document.createElement('div');
        msgDiv.className = `message ${isMe ? 'sent' : 'received'}`;
        
        let contentHtml = '';
        if (msg.type === 'text') {
            contentHtml = msg.text;
        } else if (msg.type === 'image') {
            contentHtml = `<img src="${msg.url}" class="msg-image" onclick="window.open(this.src)">`;
        } else if (msg.type === 'audio') {
            contentHtml = `<audio controls src="${msg.url}" class="audio-player"></audio>`;
        }

        const time = new Date(msg.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

        msgDiv.innerHTML = `
            ${contentHtml}
            <div class="msg-time">${time}</div>
        `;
        
        chatArea.appendChild(msgDiv);
        chatArea.scrollTop = chatArea.scrollHeight;
    });

    // --- RESİM YÜKLEME ---
    window.uploadImage = function(input) {
        const file = input.files[0];
        if (!file) return;

        const storageRef = sRef(storage, 'images/' + Date.now() + '_' + file.name);
        uploadBytes(storageRef, file).then((snapshot) => {
            getDownloadURL(snapshot.ref).then((url) => {
                push(messagesRef, {
                    sender: currentUser.uid,
                    type: 'image',
                    url: url,
                    timestamp: serverTimestamp()
                });
            });
        });
    }

    // --- SES KAYDI (Audio) ---
    let mediaRecorder;
    let audioChunks = [];
    const recordingUI = document.getElementById('recording-ui');
    const recTimer = document.getElementById('rec-timer');
    let recStartTime;
    let recInterval;

    window.startRecording = async function(e) {
        e.preventDefault(); // Seçim vb engelle
        if (msgInput.value.length > 0) return; // Yazı varsa kayıt yapma

        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                audioChunks.push(event.data);
            };

            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/mp3' });
                uploadAudio(audioBlob);
                clearInterval(recInterval);
                recordingUI.style.display = 'none';
                msgInput.style.display = 'block';
            };

            mediaRecorder.start();
            
            // UI Güncelle
            msgInput.style.display = 'none';
            recordingUI.style.display = 'flex';
            recStartTime = Date.now();
            recInterval = setInterval(() => {
                const diff = Math.floor((Date.now() - recStartTime) / 1000);
                const m = Math.floor(diff / 60).toString().padStart(2, '0');
                const s = (diff % 60).toString().padStart(2, '0');
                recTimer.innerText = `${m}:${s}`;
            }, 1000);

        } catch (err) {
            console.error("Mikrofon hatası:", err);
            alert("Mikrofona erişilemedi.");
        }
    }

    window.stopRecording = function(e) {
        if (mediaRecorder && mediaRecorder.state !== "inactive") {
            mediaRecorder.stop();
        }
    }

    function uploadAudio(blob) {
        const storageRef = sRef(storage, 'voice/' + Date.now() + '.mp3');
        uploadBytes(storageRef, blob).then((snapshot) => {
            getDownloadURL(snapshot.ref).then((url) => {
                push(messagesRef, {
                    sender: currentUser.uid,
                    type: 'audio',
                    url: url,
                    timestamp: serverTimestamp()
                });
            });
        });
    }

</script>
</body>
</html>
