<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>VINotes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #0f172a;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #334155;
            --text-muted: #94a3b8;
            --danger: #ef4444;
            --radius: 12px; /* Daha kompakt görünüm için radius küçüldü */
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.3s ease;
        }
        .auth-container { width: 100%; max-width: 320px; text-align: center; margin-bottom: 10vh; }
        .brand-logo { font-size: 56px; color: var(--primary); margin-bottom: 10px; background: #eff6ff; padding: 12px; border-radius: 20px; }
        .brand-title { font-size: 1.8rem; font-weight: 800; color: var(--secondary); margin-bottom: 25px; }
        .btn-login {
            background: var(--primary); color: white; border: none; padding: 14px;
            border-radius: var(--radius); font-weight: 600; width: 100%; cursor: pointer;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.2);
        }

        /* --- APP HEADER --- */
        #app-screen { display: none; height: 100%; flex-direction: column; }
        
        header {
            padding: 15px 20px; background: var(--surface); z-index: 10;
            display: flex; flex-direction: column; gap: 10px; border-bottom: 1px solid #e2e8f0;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-top h2 { font-size: 1.3rem; font-weight: 800; color: var(--secondary); }
        
        .search-container { position: relative; width: 100%; }
        .search-input {
            width: 100%; background: var(--bg); border: none; padding: 10px 10px 10px 38px;
            border-radius: 8px; font-size: 0.9rem; outline: none; color: var(--text-main);
        }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 18px;}

        /* --- MAIN LISTS --- */
        main { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Özet Kartı */
        .balance-card {
            background: linear-gradient(135deg, #1e293b, #334155); color: white;
            padding: 20px; border-radius: 16px; margin-bottom: 20px; text-align: center;
            box-shadow: 0 8px 15px -3px rgba(30, 41, 59, 0.2);
        }
        .balance-amount { font-size: 2rem; font-weight: 800; margin: 5px 0 10px; }

        /* YENİ TASARIM: TEK SATIR (Compact Row) */
        .compact-item {
            background: var(--surface); padding: 12px 15px; border-radius: 10px;
            margin-bottom: 8px; border: 1px solid #f1f5f9;
            display: flex; align-items: center; justify-content: space-between;
            gap: 15px; /* Metin ile buton arası boşluk */
        }
        
        /* Sol taraf: Metin alanı */
        .item-content {
            flex: 1; /* Mevcut alanı kapla */
            min-width: 0; /* Flex içinde text-overflow çalışması için şart */
        }
        
        .item-title {
            font-weight: 600; font-size: 0.95rem; color: var(--secondary);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; /* Uzunsa ... koy */
        }
        .item-sub {
            font-size: 0.75rem; color: var(--text-muted); margin-top: 2px;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .item-amount { font-weight: 700; font-size: 0.9rem; margin-top: 2px; }

        /* Sağ taraf: Buton */
        .action-btn {
            flex-shrink: 0; /* Asla küçülme */
            background: #f0fdf4; color: #15803d; /* Hafif Yeşil Ton */
            border: none; width: 32px; height: 32px; border-radius: 8px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: background 0.2s;
        }
        .action-btn.delete { background: #fef2f2; color: #ef4444; } /* Silme Kırmızı */
        .action-btn:active { transform: scale(0.95); }

        /* Month Header */
        .month-header { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); margin: 20px 0 8px; padding-left: 5px; text-transform: uppercase; letter-spacing: 0.5px; }

        /* NOTLAR İÇİN GRID & EXPAND */
        .notes-grid { display: grid; grid-template-columns: 1fr; gap: 10px; }
        .note-card {
            background: var(--surface); padding: 15px; border-radius: 12px; border: 1px solid #e2e8f0;
            display: flex; flex-direction: column;
        }
        .note-title { font-weight: 700; color: var(--secondary); margin-bottom: 5px; }
        .note-body {
            font-size: 0.9rem; color: var(--text-main); line-height: 1.4;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; /* 2 satırda kes */
        }
        .note-body.expanded { -webkit-line-clamp: unset; }
        .read-more {
            font-size: 0.75rem; color: var(--primary); font-weight: 600; cursor: pointer;
            margin-top: 8px; align-self: flex-start;
        }

        /* Renkler */
        .inc { color: #16a34a; }
        .exp { color: #dc2626; }

        /* Navbar */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--surface);
            display: flex; justify-content: space-around; padding: 10px 0 20px;
            border-top: 1px solid #e2e8f0; z-index: 100;
        }
        .nav-item { border: none; background: none; display: flex; flex-direction: column; align-items: center; color: var(--text-muted); font-size: 0.7rem; width: 20%; }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 24px; }

        /* FAB & Modal */
        .fab {
            position: fixed; bottom: 85px; right: 20px; background: var(--secondary); color: white;
            width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 90; cursor: pointer;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            display: none; justify-content: center; align-items: flex-end; z-index: 3000;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 500px;
            border-radius: 20px 20px 0 0; padding: 25px; animation: slideUp 0.3s;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* Form */
        .form-group { margin-bottom: 15px; }
        .form-control, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 10px; font-size: 0.95rem; outline: none; background: #fff; }
        .type-selector { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; }
        .type-chip { padding: 8px 16px; border-radius: 8px; background: #f1f5f9; color: var(--text-muted); font-size: 0.85rem; font-weight: 600; white-space: nowrap; }
        .type-chip.selected { background: var(--secondary); color: white; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-container">
            <span class="material-icons-round brand-logo">lock</span>
            <div class="brand-title">VINotes</div>
            <form id="loginForm">
                <div class="form-group"><input type="email" id="loginEmail" class="form-control" placeholder="e-Mail" required></div>
                <div class="form-group"><input type="password" id="loginPassword" class="form-control" placeholder="Password" required></div>
                <button type="submit" class="btn-login">Login</button>
            </form>
            <p id="authMsg" style="color:var(--danger); margin-top:10px; font-size:0.8rem;"></p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="header-top">
                <h2>Cüzdan</h2>
                <button onclick="logout()" style="background:#fee2e2; border:none; padding:8px; border-radius:8px; color:#ef4444; cursor:pointer; display:flex;">
                    <span class="material-icons-round">logout</span>
                </button>
            </div>
            <div class="search-container">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Ara...">
            </div>
        </header>

        <main>
            <section id="view-finance" class="section active">
                <div class="balance-card">
                    <p style="opacity:0.8; font-size:0.85rem;">Net Durum</p>
                    <div class="balance-amount" id="totalBalance">₺0,00</div>
                    <div style="display:flex; justify-content:space-between; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px;">
                        <div><span style="font-size:0.75rem;">Gelir</span><br><strong class="inc" id="totalIncome">₺0</strong></div>
                        <div><span style="font-size:0.75rem;">Gider</span><br><strong class="exp" id="totalExpense">₺0</strong></div>
                    </div>
                </div>
                <div id="financeContainer"></div>
            </section>

            <section id="view-debts" class="section">
                <div id="debtsContainer"></div>
            </section>

            <section id="view-vault" class="section">
                <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); margin:10px 0;">BANKA HESAPLARI</div>
                <div id="bankContainer"></div>
                
                <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); margin:20px 0 10px;">PAROLALAR</div>
                <div id="passContainer"></div>
            </section>

            <section id="view-assets" class="section">
                 <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); margin:10px 0;">ARAÇLAR</div>
                 <div id="vehicleContainer"></div>

                 <div style="font-size:0.8rem; font-weight:700; color:var(--text-muted); margin:20px 0 10px;">VERGİLER</div>
                 <div id="taxContainer"></div>
            </section>

            <section id="view-notes" class="section">
                <div id="notesContainer" class="notes-grid"></div>
            </section>
        </main>

        <div class="fab" id="fabBtn"><span class="material-icons-round">add</span></div>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="switchTab('finance')"><span class="material-icons-round">account_balance_wallet</span><span>Cüzdan</span></button>
            <button class="nav-item" onclick="switchTab('debts')"><span class="material-icons-round">handshake</span><span>Borçlar</span></button>
            <button class="nav-item" onclick="switchTab('vault')"><span class="material-icons-round">lock</span><span>Kasa</span></button>
            <button class="nav-item" onclick="switchTab('assets')"><span class="material-icons-round">directions_car</span><span>Varlık</span></button>
            <button class="nav-item" onclick="switchTab('notes')"><span class="material-icons-round">edit_note</span><span>Notlar</span></button>
        </nav>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
                <h3>Yeni Kayıt</h3>
                <span class="material-icons-round" id="closeModal" style="cursor:pointer;">close</span>
            </div>
            <div class="form-group">
                <select id="entryType" class="form-control" onchange="updateFormFields()">
                    <option value="finance">Gelir / Gider</option>
                    <option value="debt">Borç / Alacak</option>
                    <option value="bank">Banka / IBAN</option>
                    <option value="password">Parola</option>
                    <option value="vehicle">Araç</option>
                    <option value="tax">Vergi</option>
                    <option value="note">Not</option>
                </select>
            </div>
            <form id="dataForm">
                <div id="dynamicFields"></div>
                <button type="submit" class="btn-login" style="margin-top:15px;">Kaydet</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyDm5yzzoIqzsqF7TMvT7eInZXBZINSwN-w",
  authDomain: "pa-hmd-s7v1.firebaseapp.com",
  projectId: "pa-hmd-s7v1",
  storageBucket: "pa-hmd-s7v1.firebasestorage.app",
  messagingSenderId: "1057040915282",
  appId: "1:1057040915282:web:d80d4818610a55e1fb788b",
  measurementId: "G-XK9835JN19"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // OTOMATİK ÇIKIŞ (REFRESH & INACTIVITY)
        // 1. Refresh yapılınca çıkış olsun diye Persistence'ı Session yapıyoruz (Tab kapanınca gider).
        // Eğer kesinlikle refresh'te de gitsin isteniyorsa window.onload'da signout yapılabilir ama 
        // session persistence en doğrusudur.
        setPersistence(auth, browserSessionPersistence);

        // 2. Hareketsizlik Kontrolü (5 Dakika)
        let idleTime = 0;
        const resetIdle = () => idleTime = 0;
        window.onload = resetIdle;
        window.onmousemove = resetIdle;
        window.onkeypress = resetIdle;
        window.ontouchstart = resetIdle;
        
        setInterval(() => {
            idleTime++;
            if (idleTime >= 5) { // 5 Dakika
                if(auth.currentUser) {
                    alert("Hareketsizlik nedeniyle güvenlik çıkışı yapıldı.");
                    signOut(auth);
                }
            }
        }, 60000); // Her 1 dakikada kontrol

        // Ayrıca sayfa yüklendiğinde zorla çıkış (İsteğin üzerine)
        window.addEventListener('load', () => {
           // Sayfa yenilendiğinde oturumu kapatmak istersen bu satırı aç:
           signOut(auth); 
        });


        let currentUser = null;
        let subType = 'income';

        // --- AUTH ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.transform = "translateY(-100%)";
                document.getElementById('app-screen').style.display = "flex";
                loadData(); // Verileri dinlemeye başla
            } else {
                currentUser = null;
                document.getElementById('loginForm').reset(); // Formu temizle
                document.getElementById('auth-screen').style.transform = "translateY(0)";
                document.getElementById('app-screen').style.display = "none";
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value)
            .catch(err => document.getElementById('authMsg').textContent = "Hatalı giriş.");
        });

        window.logout = () => signOut(auth);

        // --- DATA YÖNETİMİ ---
        
        // Not: loadData sadece bir kere çağrılmalı. Çifte kaydı önlemek için innerHTML'i temizliyoruz.
        function loadData() {
            const uid = currentUser.uid;

            // 1. FINANS
            onSnapshot(query(collection(db, `users/${uid}/transactions`), orderBy('date', 'desc')), (snap) => {
                const con = document.getElementById('financeContainer');
                con.innerHTML = ''; // Temizle
                let tInc = 0, tExp = 0, lastM = '';
                
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.type==='income') tInc+=d.amount; else tExp+=d.amount;
                    
                    const date = new Date(d.date);
                    const mKey = date.toLocaleString('tr-TR', {month:'long', year:'numeric'});
                    if(mKey !== lastM) {
                        con.innerHTML += `<div class="month-header">${mKey}</div>`;
                        lastM = mKey;
                    }
                    
                    // TEK SATIR DİZAYN (Text Overflow Ellipsis)
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title">${d.desc}</div>
                            <div class="item-sub">${date.toLocaleDateString('tr-TR')}</div>
                            <div class="item-amount ${d.type==='income'?'inc':'exp'}">
                                ${d.type==='income'?'+':'-'}₺${d.amount.toLocaleString('tr-TR')}
                            </div>
                        </div>
                        <button class="action-btn delete" onclick="del('transactions','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
                document.getElementById('totalBalance').textContent = `₺${(tInc-tExp).toLocaleString('tr-TR')}`;
                document.getElementById('totalIncome').textContent = `₺${tInc.toLocaleString('tr-TR')}`;
                document.getElementById('totalExpense').textContent = `₺${tExp.toLocaleString('tr-TR')}`;
            });

            // 2. BORÇLAR
            onSnapshot(query(collection(db, `users/${uid}/debts`), orderBy('date', 'desc')), (snap) => {
                const con = document.getElementById('debtsContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isRec = d.type === 'receivable';
                    const goldVal = (d.goldGram||0)*(d.goldPrice||0);
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title" style="color:${isRec?'#15803d':'#c2410c'}">
                                ${isRec?'ALACAK':'BORÇ'}: ${d.person}
                            </div>
                            <div class="item-sub">Vade: ${d.dueDate?new Date(d.dueDate).toLocaleDateString('tr-TR'):'Yok'}</div>
                            ${goldVal>0 ? `<div style="font-size:0.8rem; font-weight:600;">₺${goldVal.toLocaleString('tr-TR')} (${d.goldGram}g)</div>` : ''}
                        </div>
                        <button class="action-btn delete" onclick="del('debts','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
            });

            // 3. BANKALAR (AYRI CONTAINER - Çakışmayı önler)
            onSnapshot(collection(db, `users/${uid}/banks`), (snap) => {
                const con = document.getElementById('bankContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title">${d.bankName}</div>
                            <div class="item-sub">${d.iban}</div>
                        </div>
                        <button class="action-btn" onclick="copy('${d.iban}')" style="margin-right:5px;">
                            <span class="material-icons-round" style="font-size:18px;">content_copy</span>
                        </button>
                        <button class="action-btn delete" onclick="del('banks','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
            });

            // 4. PAROLALAR (AYRI CONTAINER)
            onSnapshot(collection(db, `users/${uid}/passwords`), (snap) => {
                const con = document.getElementById('passContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title">${d.site}</div>
                            <div class="item-sub">${d.user}</div>
                        </div>
                        <button class="action-btn" onclick="alert('${d.pass}')" style="margin-right:5px;">
                            <span class="material-icons-round" style="font-size:18px;">visibility</span>
                        </button>
                        <button class="action-btn delete" onclick="del('passwords','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
            });

            // 5. ARAÇLAR (AYRI CONTAINER)
            onSnapshot(collection(db, `users/${uid}/vehicles`), (snap) => {
                const con = document.getElementById('vehicleContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title">${d.plate}</div>
                            <div class="item-sub">Bakım: ${d.nextDate?new Date(d.nextDate).toLocaleDateString('tr-TR'):'-'}</div>
                        </div>
                        <button class="action-btn delete" onclick="del('vehicles','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
            });
            
            // 6. VERGİLER (AYRI CONTAINER)
            onSnapshot(collection(db, `users/${uid}/taxes`), (snap) => {
                const con = document.getElementById('taxContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    con.innerHTML += `
                    <div class="compact-item searchable-item">
                        <div class="item-content">
                            <div class="item-title">${d.name}</div>
                            <div class="item-sub">Son Ödeme: ${d.date?new Date(d.date).toLocaleDateString('tr-TR'):'-'}</div>
                        </div>
                        <button class="action-btn delete" onclick="del('taxes','${doc.id}')">
                            <span class="material-icons-round" style="font-size:18px;">delete</span>
                        </button>
                    </div>`;
                });
            });

            // 7. NOTLAR (CLAMP & READ MORE)
            onSnapshot(query(collection(db, `users/${uid}/notes`), orderBy('createdAt', 'desc')), (snap) => {
                const con = document.getElementById('notesContainer');
                con.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const noteId = doc.id;
                    con.innerHTML += `
                    <div class="note-card searchable-item">
                        <div style="display:flex; justify-content:space-between;">
                            <div class="note-title">${d.title}</div>
                            <span class="material-icons-round" style="color:#ef4444; font-size:18px; cursor:pointer;" onclick="del('notes','${doc.id}')">delete</span>
                        </div>
                        <div class="note-body" id="note-${noteId}">${d.content}</div>
                        <div class="read-more" onclick="toggleNote('${noteId}', this)">Devamını Oku</div>
                    </div>`;
                });
            });
        }

        // --- GLOBAL ACTIONS ---
        window.del = async (col, id) => { if(confirm("Silmek istediğine emin misin?")) await deleteDoc(doc(db, `users/${currentUser.uid}/${col}`, id)); };
        window.copy = (t) => { navigator.clipboard.writeText(t); alert("Kopyalandı"); };
        
        window.toggleNote = (id, btn) => {
            const body = document.getElementById(`note-${id}`);
            if(body.classList.contains('expanded')) {
                body.classList.remove('expanded');
                btn.textContent = "Devamını Oku";
            } else {
                body.classList.add('expanded');
                btn.textContent = "Kapat";
            }
        };

        window.switchTab = (tab) => {
            document.querySelectorAll('.section').forEach(e => e.classList.remove('active'));
            document.getElementById(`view-${tab}`).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
            window.scrollTo(0,0);
        };

        // --- FORM LOGIC ---
        const modal = document.getElementById('addModal');
        document.getElementById('fabBtn').onclick = () => { 
            modal.classList.add('open'); 
            // Bugünün tarihi
            const today = new Date().toISOString().split('T')[0];
            updateFormFields(today);
        };
        document.getElementById('closeModal').onclick = () => modal.classList.remove('open');

        window.updateFormFields = (defaultDate = '') => {
            const type = document.getElementById('entryType').value;
            const container = document.getElementById('dynamicFields');
            let html = '';
            
            if(type==='finance') {
                html = `
                <div class="type-selector">
                    <div class="type-chip selected" onclick="subType='income'; hl(this)">Gelir</div>
                    <div class="type-chip" onclick="subType='expense'; hl(this)">Gider</div>
                </div>
                <div class="form-group"><input type="date" id="fDate" class="form-control" value="${defaultDate}"></div>
                <div class="form-group"><input type="text" id="fDesc" class="form-control" placeholder="Açıklama"></div>
                <div class="form-group"><input type="number" id="fAmount" class="form-control" placeholder="Tutar ₺" step="0.01"></div>`;
                subType = 'income';
            } else if(type==='debt') {
                html = `
                <div class="type-selector">
                    <div class="type-chip selected" onclick="subType='receivable'; hl(this)">Alacak</div>
                    <div class="type-chip" onclick="subType='debt'; hl(this)">Borç</div>
                </div>
                <div class="form-group"><input type="text" id="dPerson" class="form-control" placeholder="Kişi"></div>
                <div class="form-group"><input type="date" id="dDate" class="form-control" value="${defaultDate}"></div>
                <div style="display:flex; gap:10px;">
                   <input type="number" id="dGold" class="form-control" placeholder="Gr Altın" step="0.01">
                   <input type="number" id="dPrice" class="form-control" placeholder="Kur" step="0.01">
                </div>
                <div class="form-group" style="margin-top:10px;"><label style="font-size:0.8rem;">Vade</label><input type="date" id="dDue" class="form-control"></div>`;
                subType = 'receivable';
            } else if(type==='bank') {
                html = `<input type="text" id="bName" class="form-control" placeholder="Banka" style="margin-bottom:10px">
                        <input type="text" id="bIban" class="form-control" placeholder="IBAN">`;
            } else if(type==='password') {
                html = `<input type="text" id="pSite" class="form-control" placeholder="Site" style="margin-bottom:10px">
                        <input type="text" id="pUser" class="form-control" placeholder="Kullanıcı" style="margin-bottom:10px">
                        <input type="text" id="pPass" class="form-control" placeholder="Parola">`;
            } else if(type==='vehicle') {
                html = `<input type="text" id="vPlate" class="form-control" placeholder="Plaka" style="margin-bottom:10px">
                        <label style="font-size:0.8rem">Gelecek Bakım</label><input type="date" id="vNext" class="form-control">`;
            } else if(type==='tax') {
                html = `<input type="text" id="tName" class="form-control" placeholder="Vergi Adı" style="margin-bottom:10px">
                        <label style="font-size:0.8rem">Son Ödeme</label><input type="date" id="tDate" class="form-control">`;
            } else if(type==='note') {
                html = `<input type="text" id="nTitle" class="form-control" placeholder="Başlık" style="margin-bottom:10px">
                        <textarea id="nContent" class="form-control" rows="4" placeholder="Not"></textarea>`;
            }
            container.innerHTML = html;
        };

        window.hl = (el) => {
            document.querySelectorAll('.type-chip').forEach(c=>c.classList.remove('selected'));
            el.classList.add('selected');
        }

        document.getElementById('dataForm').addEventListener('submit', async(e)=>{
            e.preventDefault();
            if(!currentUser) return;
            const uid = currentUser.uid;
            const type = document.getElementById('entryType').value;
            let col='', data={createdAt: serverTimestamp()};

            if(type==='finance') {
                col='transactions'; 
                data={...data, type:subType, date:document.getElementById('fDate').value, desc:document.getElementById('fDesc').value, amount:parseFloat(document.getElementById('fAmount').value)||0};
            } else if(type==='debt') {
                col='debts';
                data={...data, type:subType, person:document.getElementById('dPerson').value, date:document.getElementById('dDate').value, goldGram:parseFloat(document.getElementById('dGold').value)||0, goldPrice:parseFloat(document.getElementById('dPrice').value)||0, dueDate:document.getElementById('dDue').value};
            } else if(type==='bank') {
                col='banks'; data={...data, bankName:document.getElementById('bName').value, iban:document.getElementById('bIban').value};
            } else if(type==='password') {
                col='passwords'; data={...data, site:document.getElementById('pSite').value, user:document.getElementById('pUser').value, pass:document.getElementById('pPass').value};
            } else if(type==='vehicle') {
                col='vehicles'; data={...data, plate:document.getElementById('vPlate').value, nextDate:document.getElementById('vNext').value};
            } else if(type==='tax') {
                col='taxes'; data={...data, name:document.getElementById('tName').value, date:document.getElementById('tDate').value};
            } else if(type==='note') {
                col='notes'; data={...data, title:document.getElementById('nTitle').value, content:document.getElementById('nContent').value};
            }

            await addDoc(collection(db, `users/${uid}/${col}`), data);
            modal.classList.remove('open');
        });

        // ARAMA
        document.getElementById('searchInput').addEventListener('keyup', (e)=>{
            const term = e.target.value.toLowerCase();
            const section = document.querySelector('.section.active');
            section.querySelectorAll('.searchable-item').forEach(item => {
                const txt = item.innerText.toLowerCase();
                item.style.display = txt.includes(term) ? 'flex' : 'none'; // Flex yapısı bozulmasın
            });
        });

    </script>
</body>
</html>