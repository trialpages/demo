<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    
    <title>VINotes</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        :root {
            --primary: #2563eb;
            --secondary: #0f172a;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text-main: #334155;
            --text-muted: #94a3b8;
            --radius: 16px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { background-color: var(--bg); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #auth-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--surface); z-index: 2000;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center;
            padding: 30px; transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }
        .auth-container { width: 100%; max-width: 360px; margin-bottom: 15vh; text-align: center; }
        .brand-logo { 
            font-size: 64px; color: var(--primary); margin-bottom: 15px; 
            background: #eff6ff; padding: 15px; border-radius: 24px; display:inline-block;
        }
        .brand-title { font-size: 2rem; font-weight: 800; color: var(--secondary); letter-spacing: -1px; margin-bottom: 30px; }
        
        .btn-login {
            background: var(--primary); color: white; border: none; padding: 16px;
            border-radius: var(--radius); font-size: 1rem; font-weight: 600; cursor: pointer;
            width: 100%; margin-top: 15px; box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
            transition: transform 0.1s;
        }
        .btn-login:active { transform: scale(0.98); }

        /* --- APP STRUCTURE --- */
        #app-screen { display: none; height: 100%; flex-direction: column; }
        
        header {
            padding: 15px 20px; background: var(--surface); z-index: 10;
            display: flex; flex-direction: column; gap: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-top h2 { font-size: 1.4rem; font-weight: 800; color: var(--secondary); letter-spacing: -0.5px; }
        
        .search-container { position: relative; width: 100%; }
        .search-input {
            width: 100%; background: var(--bg); border: none; padding: 12px 12px 12px 42px;
            border-radius: 12px; font-size: 0.95rem; outline: none; color: var(--text-main);
        }
        .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }

        .logout-btn { color: #ef4444; background: #fee2e2; border: none; padding: 8px; border-radius: 8px; cursor: pointer; display: flex; }

        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; }
        .section { display: none; animation: fadeIn 0.3s ease; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CARDS & LISTS (GÜNCELLENDİ) --- */
        .balance-card {
            background: linear-gradient(135deg, #1e293b, #334155);
            color: white; padding: 24px; border-radius: 20px;
            margin-bottom: 25px; text-align: center; box-shadow: 0 10px 25px -5px rgba(30, 41, 59, 0.25);
        }
        .balance-amount { font-size: 2.2rem; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
        
        .month-header {
            font-size: 0.8rem; font-weight: 700; color: var(--text-muted); margin: 25px 0 10px;
            text-transform: uppercase; letter-spacing: 1px; padding-left: 5px; 
        }

        .data-card {
            background: var(--surface); padding: 16px; border-radius: 16px;
            margin-bottom: 12px; border: 1px solid #f1f5f9;
            display: flex; flex-direction: column; gap: 8px; /* İçerik arası boşluk */
        }
        
        /* Kartın Üst Kısmı: Başlık ve Değer */
        .card-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
        .card-title { font-weight: 600; font-size: 1rem; color: var(--secondary); line-height: 1.4; }
        .card-badge { 
            font-size: 0.85rem; padding: 4px 10px; border-radius: 8px; font-weight: 700; 
            white-space: nowrap; flex-shrink: 0;
        }
        
        /* Kartın Alt Kısmı: Tarih/Detay ve Sil Butonu */
        .card-footer {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 5px; padding-top: 8px; border-top: 1px dashed #f1f5f9;
        }
        .card-sub { font-size: 0.8rem; color: var(--text-muted); font-weight: 500; }
        
        .delete-btn { 
            color: var(--text-muted); cursor: pointer; padding: 5px; 
            border-radius: 6px; transition: all 0.2s; 
            /* Artık absolute değil, akışın içinde */
        }
        .delete-btn:hover { background: #fee2e2; color: #ef4444; }

        /* Renkler */
        .bg-green { background: #dcfce7; color: #166534; }
        .bg-red { background: #fee2e2; color: #991b1b; }
        .bg-blue { background: #dbeafe; color: #1e40af; }
        .bg-orange { background: #ffedd5; color: #9a3412; }

        .copy-box {
            background: #f8fafc; padding: 10px; border-radius: 8px; font-family: monospace; font-size: 0.9rem;
            display: flex; justify-content: space-between; align-items: center; margin-top: 5px; border: 1px solid #e2e8f0;
        }
        .copy-link { color: var(--primary); font-weight: 700; font-size: 0.75rem; cursor: pointer; border: none; background: none; }

        /* --- NAVIGATION --- */
        .nav-bar {
            position: fixed; bottom: 0; width: 100%; background: var(--surface);
            display: flex; justify-content: space-around; padding: 10px 5px 25px;
            border-top: 1px solid #e2e8f0; z-index: 100;
        }
        .nav-item {
            background: none; border: none; display: flex; flex-direction: column; align-items: center;
            color: var(--text-muted); font-size: 0.7rem; cursor: pointer; width: 20%;
        }
        .nav-item.active { color: var(--primary); }
        .nav-item .material-icons-round { font-size: 26px; margin-bottom: 2px; }

        /* --- MODAL --- */
        .fab {
            position: fixed; bottom: 95px; right: 20px; background: var(--secondary);
            color: white; width: 56px; height: 56px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); cursor: pointer; z-index: 90;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); z-index: 3000;
            display: none; justify-content: center; align-items: flex-end;
        }
        .modal-overlay.open { display: flex; }
        .modal-content {
            background: var(--surface); width: 100%; max-width: 600px;
            border-radius: 24px 24px 0 0; padding: 25px; max-height: 85vh; overflow-y: auto;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.8rem; margin-bottom: 6px; color: var(--text-muted); font-weight: 600; }
        .form-control, select {
            width: 100%; padding: 14px; border: 1px solid #cbd5e1; border-radius: 12px;
            font-size: 1rem; background: #fff; outline: none; transition: border 0.2s;
        }
        .form-control:focus { border-color: var(--primary); }

        .type-selector { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .type-chip {
            padding: 10px 20px; border-radius: 10px; background: #f1f5f9; color: var(--text-muted);
            font-size: 0.9rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s;
        }
        .type-chip.selected { background: var(--secondary); color: white; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="auth-container">
            <span class="material-icons-round brand-logo">verified_user</span>
            <div class="brand-title">VINotes</div>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-control" placeholder="E-posta" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-control" placeholder="Parola" required>
                </div>
                <button type="submit" class="btn-login">Giriş Yap</button>
            </form>
            <p id="authError" style="color: #ef4444; margin-top: 15px; font-size: 0.9rem; min-height: 20px;"></p>
        </div>
    </div>

    <div id="app-screen">
        <header>
            <div class="header-top">
                <h2 id="page-title">Cüzdan</h2>
                <button class="logout-btn" id="btnLogout"><span class="material-icons-round">power_settings_new</span></button>
            </div>
            <div class="search-container">
                <span class="material-icons-round search-icon">search</span>
                <input type="text" id="searchInput" class="search-input" placeholder="Tüm kayıtlarda ara...">
            </div>
        </header>

        <main>
            <section id="view-finance" class="section active">
                <div class="balance-card">
                    <p style="font-size:0.9rem; opacity:0.8; margin-bottom:5px;">Net Varlık</p>
                    <div class="balance-amount" id="totalBalance">₺0,00</div>
                    <div style="display:flex; justify-content:space-between; border-top:1px solid rgba(255,255,255,0.1); padding-top:15px; margin-top:15px;">
                        <div>Gelir <br><strong style="color:#4ade80;" id="totalIncome">₺0</strong></div>
                        <div>Gider <br><strong style="color:#f87171;" id="totalExpense">₺0</strong></div>
                    </div>
                </div>
                <div id="financeListContainer"></div>
            </section>

            <section id="view-debts" class="section">
                <div id="debtsListContainer"></div>
            </section>

            <section id="view-vault" class="section">
                <div style="margin-bottom:15px; font-size:0.85rem; font-weight:600; color:var(--text-muted);">HESAPLAR & PAROLALAR</div>
                <div id="vaultListContainer"></div>
            </section>

            <section id="view-assets" class="section">
                 <div id="assetsListContainer"></div>
            </section>

            <section id="view-notes" class="section">
                <div id="notesListContainer"></div>
            </section>
        </main>

        <button class="fab" id="fabBtn"><span class="material-icons-round">add</span></button>

        <nav class="nav-bar">
            <button class="nav-item active" onclick="switchTab('finance')">
                <span class="material-icons-round">account_balance_wallet</span>
                <span>Cüzdan</span>
            </button>
            <button class="nav-item" onclick="switchTab('debts')">
                <span class="material-icons-round">handshake</span>
                <span>Borçlar</span>
            </button>
            <button class="nav-item" onclick="switchTab('vault')">
                <span class="material-icons-round">lock</span>
                <span>Kasa</span>
            </button>
            <button class="nav-item" onclick="switchTab('assets')">
                <span class="material-icons-round">directions_car</span>
                <span>Varlık</span>
            </button>
            <button class="nav-item" onclick="switchTab('notes')">
                <span class="material-icons-round">edit_note</span>
                <span>Notlar</span>
            </button>
        </nav>
    </div>

    <div class="modal-overlay" id="addModal">
        <div class="modal-content">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3>Yeni Kayıt</h3>
                <span class="material-icons-round" id="closeModal" style="cursor:pointer; color:var(--text-muted); background:#f1f5f9; padding:5px; border-radius:50%;">close</span>
            </div>

            <div class="form-group">
                <label class="form-label">Kategori</label>
                <select id="entryType" class="form-control" onchange="updateFormFields()">
                    <option value="finance">Gelir / Gider</option>
                    <option value="debt">Borç / Alacak</option>
                    <option value="bank">Banka / IBAN</option>
                    <option value="password">Parola</option>
                    <option value="tax">Yıllık Vergi</option>
                    <option value="vehicle">Araç Bilgisi</option>
                    <option value="note">Not</option>
                </select>
            </div>

            <form id="dataForm">
                <div id="fields-finance">
                    <div class="type-selector">
                        <div class="type-chip selected" onclick="setType('income', this)">Gelir</div>
                        <div class="type-chip" onclick="setType('expense', this)">Gider</div>
                    </div>
                    <div class="form-group"><label class="form-label">Tarih</label><input type="date" id="finDate" class="form-control" required></div>
                    <div class="form-group"><label class="form-label">Açıklama</label><input type="text" id="finDesc" class="form-control" placeholder="Örn: Maaş, Market"></div>
                    <div class="form-group"><label class="form-label">Tutar</label><input type="number" id="finAmount" class="form-control" placeholder="₺" step="0.01"></div>
                </div>

                <div id="fields-debt" style="display:none;">
                    <div class="type-selector">
                        <div class="type-chip selected" onclick="setType('receivable', this)">Alacak</div>
                        <div class="type-chip" onclick="setType('debt', this)">Borç</div>
                    </div>
                    <div class="form-group"><label class="form-label">Kişi</label><input type="text" id="debtPerson" class="form-control" placeholder="Ad Soyad"></div>
                    <div class="form-group"><label class="form-label">İşlem Tarihi</label><input type="date" id="debtDate" class="form-control"></div>
                    <div style="display:flex; gap:10px;">
                        <div class="form-group" style="flex:1;"><label class="form-label">Altın (Gr)</label><input type="number" id="debtGoldGram" class="form-control" step="0.01"></div>
                        <div class="form-group" style="flex:1;"><label class="form-label">Kur (₺)</label><input type="number" id="debtGoldPrice" class="form-control" step="0.01"></div>
                    </div>
                    <div class="form-group"><label class="form-label">Vade Tarihi</label><input type="date" id="debtDueDate" class="form-control"></div>
                </div>

                <div id="fields-bank" style="display:none;">
                    <div class="form-group"><label class="form-label">Banka</label><input type="text" id="bankName" class="form-control" placeholder="Banka Adı"></div>
                    <div class="form-group"><label class="form-label">Hesap Sahibi</label><input type="text" id="bankAccount" class="form-control"></div>
                    <div class="form-group"><label class="form-label">IBAN</label><input type="text" id="bankIban" class="form-control" placeholder="TR..."></div>
                </div>

                <div id="fields-password" style="display:none;">
                    <div class="form-group"><label class="form-label">Site / Uygulama</label><input type="text" id="passSite" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Kullanıcı Adı</label><input type="text" id="passUser" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Parola</label><input type="text" id="passSecret" class="form-control"></div>
                </div>

                <div id="fields-tax" style="display:none;">
                    <div class="form-group"><label class="form-label">Vergi Adı</label><input type="text" id="taxName" class="form-control" placeholder="MTV, Emlak vb."></div>
                    <div class="form-group"><label class="form-label">Son Ödeme</label><input type="date" id="taxDate" class="form-control"></div>
                </div>

                <div id="fields-vehicle" style="display:none;">
                    <div class="form-group"><label class="form-label">Plaka</label><input type="text" id="vehPlate" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Son Bakım</label><input type="date" id="vehLastDate" class="form-control"></div>
                    <div class="form-group"><label class="form-label">Gelecek Bakım</label><input type="date" id="vehNextDate" class="form-control"></div>
                </div>

                <div id="fields-note" style="display:none;">
                    <div class="form-group"><label class="form-label">Başlık</label><input type="text" id="noteTitle" class="form-control"></div>
                    <div class="form-group"><label class="form-label">İçerik</label><textarea id="noteContent" class="form-control" rows="4"></textarea></div>
                </div>

                <button type="submit" class="btn-login" style="margin-top:10px;">Kaydet</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- BURAYA KENDİ BİLGİLERİNİ GİR ---
        const firebaseConfig = {
            apiKey: "BURAYA_API_KEY",
            authDomain: "BURAYA_AUTH_DOMAIN",
            projectId: "BURAYA_PROJECT_ID",
            storageBucket: "BURAYA_STORAGE_BUCKET",
            messagingSenderId: "BURAYA_SENDER_ID",
            appId: "BURAYA_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let subType = 'income';

        // --- AUTH & LOGIN LOGIC ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('auth-screen').style.transform = "translateY(-100%)";
                document.getElementById('app-screen').style.display = "flex";
                loadAllData();
            } else {
                currentUser = null;
                // FORM TEMİZLEME (Güvenlik Fix)
                document.getElementById('loginForm').reset();
                document.getElementById('auth-screen').style.transform = "translateY(0)";
                document.getElementById('app-screen').style.display = "none";
            }
        });

        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button');
            const originalText = btn.textContent;
            btn.textContent = "Giriş Yapılıyor...";
            
            signInWithEmailAndPassword(auth, document.getElementById('loginEmail').value, document.getElementById('loginPassword').value)
                .catch(err => {
                    document.getElementById('authError').textContent = "Hatalı e-posta veya parola.";
                })
                .finally(() => { btn.textContent = originalText; });
        });

        document.getElementById('btnLogout').addEventListener('click', () => { 
            if(confirm("Güvenli çıkış yapılsın mı?")) signOut(auth); 
        });

        // --- TABS ---
        window.switchTab = (tabId) => {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-' + tabId).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            const titles = {finance:'Cüzdan', debts:'Borçlar', vault:'Kasa', assets:'Varlıklar', notes:'Notlar'};
            document.getElementById('page-title').textContent = titles[tabId];
            window.scrollTo(0,0);
        };

        // --- MODAL ---
        const modal = document.getElementById('addModal');
        document.getElementById('fabBtn').onclick = () => {
            modal.classList.add('open');
            // Tarih alanlarına bugünü ata
            const today = new Date().toISOString().split('T')[0];
            document.querySelectorAll('input[type="date"]').forEach(i => i.value = today);
            updateFormFields();
        };
        document.getElementById('closeModal').onclick = () => modal.classList.remove('open');

        window.updateFormFields = () => {
            const type = document.getElementById('entryType').value;
            document.querySelectorAll('[id^="fields-"]').forEach(el => el.style.display = 'none');
            document.getElementById('fields-' + type).style.display = 'block';
            
            // Subtype reset
            if(type === 'finance') setType('income', document.querySelector('#fields-finance .type-chip:first-child'));
            if(type === 'debt') setType('receivable', document.querySelector('#fields-debt .type-chip:first-child'));
        };

        window.setType = (val, el) => {
            subType = val;
            el.parentElement.querySelectorAll('.type-chip').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
        };

        // --- ADD DATA ---
        document.getElementById('dataForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) return;
            const uid = currentUser.uid;
            const type = document.getElementById('entryType').value;
            const btn = e.target.querySelector('button');
            btn.textContent = "Kaydediliyor...";
            btn.disabled = true;

            try {
                let colName = '';
                let data = { createdAt: serverTimestamp() };

                // Hangi koleksiyon?
                if(type === 'finance') {
                    colName = 'transactions';
                    data = { ...data, type: subType, date: document.getElementById('finDate').value, desc: document.getElementById('finDesc').value, amount: parseFloat(document.getElementById('finAmount').value) };
                } else if(type === 'debt') {
                    colName = 'debts';
                    data = { ...data, type: subType, person: document.getElementById('debtPerson').value, date: document.getElementById('debtDate').value, goldGram: parseFloat(document.getElementById('debtGoldGram').value) || 0, goldPrice: parseFloat(document.getElementById('debtGoldPrice').value) || 0, dueDate: document.getElementById('debtDueDate').value };
                } else if(type === 'bank') {
                    colName = 'banks';
                    data = { ...data, bankName: document.getElementById('bankName').value, accountName: document.getElementById('bankAccount').value, iban: document.getElementById('bankIban').value };
                } else if(type === 'password') {
                    colName = 'passwords';
                    data = { ...data, site: document.getElementById('passSite').value, user: document.getElementById('passUser').value, pass: document.getElementById('passSecret').value };
                } else if(type === 'tax') {
                    colName = 'taxes';
                    data = { ...data, name: document.getElementById('taxName').value, date: document.getElementById('taxDate').value };
                } else if(type === 'vehicle') {
                    colName = 'vehicles';
                    data = { ...data, plate: document.getElementById('vehPlate').value, lastDate: document.getElementById('vehLastDate').value, nextDate: document.getElementById('vehNextDate').value };
                } else if(type === 'note') {
                    colName = 'notes';
                    data = { ...data, title: document.getElementById('noteTitle').value, content: document.getElementById('noteContent').value };
                }

                await addDoc(collection(db, `users/${uid}/${colName}`), data);
                modal.classList.remove('open');
                document.getElementById('dataForm').reset();
            } catch (err) {
                alert("Hata: " + err.message);
            } finally {
                btn.textContent = "Kaydet";
                btn.disabled = false;
            }
        });

        // --- RENDER FUNCTIONS ---
        function loadAllData() {
            const uid = currentUser.uid;
            
            // 1. FINANS
            onSnapshot(query(collection(db, `users/${uid}/transactions`), orderBy('date', 'desc')), (snap) => {
                const list = document.getElementById('financeListContainer');
                list.innerHTML = '';
                let tInc = 0, tExp = 0, lastMonth = '';

                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.type === 'income') tInc += (d.amount || 0); else tExp += (d.amount || 0);
                    
                    const dateObj = new Date(d.date);
                    const monthKey = dateObj.toLocaleString('tr-TR', { month: 'long', year: 'numeric' });
                    
                    if(monthKey !== lastMonth) {
                        list.innerHTML += `<div class="month-header">${monthKey}</div>`;
                        lastMonth = monthKey;
                    }

                    // KART TASARIMI - FLEX İLE DÜZELTİLDİ
                    list.innerHTML += `
                        <div class="data-card searchable-item">
                            <div class="card-top">
                                <div class="card-title">${d.desc}</div>
                                <span class="card-badge ${d.type === 'income' ? 'bg-green' : 'bg-red'}">
                                    ${d.type === 'income' ? '+' : '-'}₺${d.amount.toLocaleString('tr-TR')}
                                </span>
                            </div>
                            <div class="card-footer">
                                <div class="card-sub">${dateObj.toLocaleDateString('tr-TR')}</div>
                                <span class="material-icons-round delete-btn" onclick="del('transactions','${doc.id}')">delete_outline</span>
                            </div>
                        </div>`;
                });
                document.getElementById('totalIncome').textContent = `₺${tInc.toLocaleString('tr-TR')}`;
                document.getElementById('totalExpense').textContent = `₺${tExp.toLocaleString('tr-TR')}`;
                document.getElementById('totalBalance').textContent = `₺${(tInc - tExp).toLocaleString('tr-TR')}`;
            });

            // 2. BORÇLAR
            onSnapshot(query(collection(db, `users/${uid}/debts`), orderBy('date', 'desc')), (snap) => {
                const list = document.getElementById('debtsListContainer');
                list.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const isRec = d.type === 'receivable';
                    const goldVal = (d.goldGram||0) * (d.goldPrice||0);
                    
                    list.innerHTML += `
                        <div class="data-card searchable-item">
                            <div class="card-top">
                                <div>
                                    <span class="card-badge ${isRec ? 'bg-green' : 'bg-orange'}">${isRec ? 'ALACAK' : 'BORÇ'}</span>
                                    <div class="card-title" style="margin-top:5px;">${d.person}</div>
                                </div>
                                <div style="font-weight:700; color:${isRec?'#166534':'#9a3412'}">
                                    ${goldVal>0 ? '₺'+goldVal.toLocaleString('tr-TR') : ''}
                                </div>
                            </div>
                            ${goldVal>0 ? `<div style="font-size:0.8rem; color:var(--text-muted);">${d.goldGram}g Altın (Kur: ₺${d.goldPrice})</div>` : ''}
                            <div class="card-footer">
                                <div class="card-sub">Vade: ${d.dueDate ? new Date(d.dueDate).toLocaleDateString('tr-TR') : 'Belirsiz'}</div>
                                <span class="material-icons-round delete-btn" onclick="del('debts','${doc.id}')">delete_outline</span>
                            </div>
                        </div>`;
                });
            });

            // 3. KASA & DİĞERLERİ
            renderMixedList(uid);
            onSnapshot(collection(db, `users/${uid}/notes`), (s) => renderNotes(s));
        }

        async function renderMixedList(uid) {
            // Realtime listeners for mixed items
            onSnapshot(collection(db, `users/${uid}/banks`), (snap) => updateVaultUI());
            onSnapshot(collection(db, `users/${uid}/passwords`), (snap) => updateVaultUI());
            onSnapshot(collection(db, `users/${uid}/taxes`), (snap) => updateAssetsUI());
            onSnapshot(collection(db, `users/${uid}/vehicles`), (snap) => updateAssetsUI());
        }

        // Vault UI Updater (Banks + Passwords)
        async function updateVaultUI() {
            if(!currentUser) return;
            const uid = currentUser.uid;
            const list = document.getElementById('vaultListContainer');
            list.innerHTML = '';

            const banks = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m=>m.getDocs(collection(db, `users/${uid}/banks`)));
            banks.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="data-card searchable-item" style="border-left:4px solid var(--primary);">
                        <div class="card-title">${d.bankName}</div>
                        <div class="card-sub">${d.accountName}</div>
                        <div class="copy-box">
                            <span>${d.iban}</span>
                            <button class="copy-link" onclick="copyTxt('${d.iban}')">KOPYALA</button>
                        </div>
                        <div class="card-footer" style="margin-top:0; border:none; padding-top:5px;">
                            <div></div>
                            <span class="material-icons-round delete-btn" onclick="del('banks','${doc.id}')">delete_outline</span>
                        </div>
                    </div>`;
            });

            const passes = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m=>m.getDocs(collection(db, `users/${uid}/passwords`)));
            passes.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="data-card searchable-item">
                        <div class="card-title">${d.site}</div>
                        <div class="card-sub">${d.user}</div>
                        <div class="copy-box">
                            <span>••••••</span>
                            <button class="copy-link" onclick="reveal(this, '${d.pass}')">GÖSTER</button>
                        </div>
                        <div class="card-footer" style="margin-top:0; border:none; padding-top:5px;">
                            <div></div>
                            <span class="material-icons-round delete-btn" onclick="del('passwords','${doc.id}')">delete_outline</span>
                        </div>
                    </div>`;
            });
        }

        // Assets UI Updater (Taxes + Vehicles)
        async function updateAssetsUI() {
            if(!currentUser) return;
            const uid = currentUser.uid;
            const list = document.getElementById('assetsListContainer');
            list.innerHTML = '';

            const taxes = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m=>m.getDocs(collection(db, `users/${uid}/taxes`)));
            taxes.forEach(doc => {
                const d = doc.data();
                const isLate = new Date(d.date) < new Date();
                list.innerHTML += `
                    <div class="data-card searchable-item">
                        <div class="card-top">
                            <div class="card-title">${d.name}</div>
                            <span class="card-badge bg-orange">VERGİ</span>
                        </div>
                        <div class="card-footer">
                            <div class="card-sub" style="color:${isLate?'#ef4444':''}">Son Ödeme: ${new Date(d.date).toLocaleDateString('tr-TR')}</div>
                            <span class="material-icons-round delete-btn" onclick="del('taxes','${doc.id}')">delete_outline</span>
                        </div>
                    </div>`;
            });

            const vehicles = await import("https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js").then(m=>m.getDocs(collection(db, `users/${uid}/vehicles`)));
            vehicles.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="data-card searchable-item">
                        <div class="card-top">
                            <div class="card-title">${d.plate}</div>
                            <span class="card-badge bg-blue">ARAÇ</span>
                        </div>
                        <div style="font-size:0.8rem; margin-top:5px;">
                            <div>Son Bakım: <strong>${d.lastDate?new Date(d.lastDate).toLocaleDateString('tr-TR'):'-'}</strong></div>
                            <div>Gelecek: <strong>${d.nextDate?new Date(d.nextDate).toLocaleDateString('tr-TR'):'-'}</strong></div>
                        </div>
                        <div class="card-footer">
                            <div></div>
                            <span class="material-icons-round delete-btn" onclick="del('vehicles','${doc.id}')">delete_outline</span>
                        </div>
                    </div>`;
            });
        }

        function renderNotes(snap) {
            const list = document.getElementById('notesListContainer');
            list.innerHTML = '';
            snap.forEach(doc => {
                const d = doc.data();
                list.innerHTML += `
                    <div class="data-card searchable-item">
                        <div class="card-title">${d.title}</div>
                        <p style="font-size:0.9rem; white-space:pre-wrap; line-height:1.4; color:var(--text-main); margin-top:5px;">${d.content}</p>
                        <div class="card-footer">
                            <div></div>
                            <span class="material-icons-round delete-btn" onclick="del('notes','${doc.id}')">delete_outline</span>
                        </div>
                    </div>`;
            });
        }

        // --- GLOBAL ACTIONS ---
        window.del = async (col, id) => { if(confirm("Kayıt silinsin mi?")) await deleteDoc(doc(db, `users/${currentUser.uid}/${col}`, id)); };
        window.copyTxt = (t) => { navigator.clipboard.writeText(t); alert("Kopyalandı!"); };
        window.reveal = (btn, pass) => {
            navigator.clipboard.writeText(pass);
            btn.previousElementSibling.textContent = pass;
            setTimeout(() => { btn.previousElementSibling.textContent = "••••••"; }, 3000);
        };

        // --- SEARCH ---
        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const term = e.target.value.toLowerCase();
            const activeSec = document.querySelector('.section.active');
            activeSec.querySelectorAll('.searchable-item').forEach(item => {
                item.style.display = item.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        });

    </script>
</body>
</html>